<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0061D5">
  <title>Shared Space - Secure Chat & File Sharing</title>
  
  <!-- Firebase SDK (CDN - no modules needed) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; overflow: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #0061D5;
      height: 100%;
      overflow: hidden;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
    }
    #app { height: 100%; overflow: hidden; }

    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f8f9fa;
      --bg-header: linear-gradient(135deg, #0061D5 0%, #0073e6 100%);
      --bg-page: #0061D5;
      --text-primary: #222222;
      --text-secondary: #4a4a4a;
      --text-muted: #767676;
      --border-color: #e8e8e8;
      --msg-own-bg: linear-gradient(135deg, #0061D5 0%, #0073e6 100%);
      --msg-other-bg: #f0f2f5;
      --input-bg: #ffffff;
      --input-area-bg: #ffffff;
      --button-bg: linear-gradient(135deg, #0061D5 0%, #0073e6 100%);
      --button-hover: linear-gradient(135deg, #0050b3 0%, #0061D5 100%);
      --accent: #0061D5;
      --accent-light: #e6f0ff;
      --success: #25D366;
      --online: #22c55e;
    }

    body.dark-mode {
      --bg-primary: #1a1a2e;
      --bg-secondary: #252542;
      --bg-tertiary: #1f1f3a;
      --bg-header: linear-gradient(135deg, #0050b3 0%, #0061D5 100%);
      --bg-page: #1a1a2e;
      --text-primary: #ffffff;
      --text-secondary: #c4c4c4;
      --text-muted: #888888;
      --border-color: #3d3d5c;
      --msg-other-bg: #2d2d4a;
      --input-bg: #252542;
      --input-area-bg: #252542;
      --accent: #4da6ff;
      --accent-light: #1a3a5c;
      background-color: #1a1a2e;
    }

    .welcome-screen, .form-screen {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      background: var(--bg-page);
      overflow: auto;
    }

    .welcome-card, .form-card {
      background: var(--bg-secondary);
      border-radius: 1rem;
      padding: 1.5rem;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    }

    .welcome-card-header { text-align: center; margin-bottom: 1.5rem; }
    .welcome-card-header .icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
    .welcome-card-header h1 { color: var(--text-primary); font-size: 1.5rem; margin-bottom: 0.25rem; }
    .welcome-card-header p { color: var(--text-muted); font-size: 0.875rem; }

    .welcome-options { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1.5rem; }

    .welcome-btn {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      border: 2px solid var(--border-color);
      border-radius: 0.75rem;
      background: var(--bg-tertiary);
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }
    .welcome-btn:hover { border-color: var(--accent); background: var(--accent-light); }
    .welcome-btn .btn-icon { font-size: 1.5rem; }
    .welcome-btn .btn-text h3 { color: var(--text-primary); font-size: 1rem; margin-bottom: 0.125rem; }
    .welcome-btn .btn-text p { color: var(--text-muted); font-size: 0.75rem; }

    .welcome-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }
    .welcome-footer span { color: var(--text-muted); font-size: 0.75rem; }

    .theme-toggle {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      padding: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1.25rem;
      line-height: 1;
    }

    .form-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; }
    .back-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      padding: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      color: var(--text-primary);
    }
    .form-header h2 { color: var(--text-primary); font-size: 1.25rem; }

    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; color: var(--text-secondary); font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
    .form-group input {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      font-size: 16px;
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      -webkit-appearance: none;
    }
    .form-group input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0, 97, 213, 0.15); }
    .form-group input::placeholder { color: var(--text-muted); }
    .form-group small { display: block; color: var(--text-muted); font-size: 0.75rem; margin-top: 0.375rem; }

    .btn {
      display: inline-block;
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      width: 100%;
      -webkit-appearance: none;
    }
    .btn-primary { background: var(--button-bg); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--button-hover); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-whatsapp {
      background: var(--success);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    .btn-whatsapp:hover { background: #1fb855; }

    .btn-small {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 0.375rem;
      border: none;
      cursor: pointer;
    }
    .btn-small:hover { background: rgba(255, 255, 255, 0.3); }

    .space-created-info {
      background: var(--accent-light);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .space-created-info h3 { color: var(--accent); font-size: 0.875rem; margin-bottom: 0.5rem; }
    .space-created-info .passcode {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.25rem;
      text-align: center;
      padding: 0.5rem;
      background: var(--bg-secondary);
      border-radius: 0.375rem;
      margin-bottom: 0.5rem;
    }
    .space-created-info small { color: var(--text-muted); font-size: 0.75rem; }

    .chat-container {
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      overflow: hidden;
    }

    .header {
      background: var(--bg-header);
      color: white;
      padding: 0.75rem 1rem;
      flex-shrink: 0;
    }
    .header-content {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-left { display: flex; align-items: center; gap: 0.75rem; }
    .header-left .icon { font-size: 1.25rem; }
    .header-left h1 { font-size: 1rem; font-weight: 700; }
    .header-left p { font-size: 0.7rem; opacity: 0.9; }
    .header-right { display: flex; align-items: center; gap: 0.375rem; }
    .header-right .btn-small { padding: 0.25rem 0.5rem; font-size: 0.75rem; }

    .online-count {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.7rem;
      background: rgba(255,255,255,0.2);
      padding: 0.125rem 0.5rem;
      border-radius: 1rem;
      margin-left: 0.5rem;
    }
    .online-dot { width: 0.5rem; height: 0.5rem; background: var(--online); border-radius: 50%; }

    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem;
      -webkit-overflow-scrolling: touch;
    }
    .messages-container { max-width: 900px; margin: 0 auto; }

    .empty-state { text-align: center; padding: 2rem 1rem; color: var(--text-muted); }
    .empty-state .icon { font-size: 2.5rem; margin-bottom: 0.75rem; }

    .message-wrapper { margin-bottom: 0.5rem; display: flex; }
    .message-wrapper.own { justify-content: flex-end; }
    .message-wrapper.other { justify-content: flex-start; }

    .message-bubble {
      max-width: 85%;
      padding: 0.625rem 0.875rem;
      border-radius: 1rem;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    .message-wrapper.own .message-bubble {
      background: var(--msg-own-bg);
      color: white;
      border-bottom-right-radius: 0.25rem;
    }
    .message-wrapper.other .message-bubble {
      background: var(--msg-other-bg);
      color: var(--text-primary);
      border-bottom-left-radius: 0.25rem;
    }

    .message-sender { font-size: 0.7rem; font-weight: 600; color: var(--accent); margin-bottom: 0.125rem; }
    .message-text { word-wrap: break-word; line-height: 1.4; font-size: 0.9375rem; }
    .message-time { font-size: 0.625rem; margin-top: 0.25rem; opacity: 0.7; }
    .message-wrapper.own .message-time { color: rgba(255, 255, 255, 0.8); }
    .message-wrapper.other .message-time { color: var(--text-muted); }

    .system-message { text-align: center; margin-bottom: 0.5rem; }
    .system-message span {
      display: inline-block;
      padding: 0.25rem 0.625rem;
      background: var(--accent-light);
      color: var(--accent);
      font-size: 0.7rem;
      border-radius: 1rem;
      font-weight: 500;
    }

    .file-info { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.375rem; }
    .file-icon { font-size: 1.25rem; }
    .file-details { flex: 1; min-width: 0; }
    .file-name { font-weight: 500; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file-size { font-size: 0.7rem; opacity: 0.7; }
    .file-preview-img { max-height: 150px; border-radius: 0.5rem; margin: 0.375rem 0; cursor: pointer; }
    .file-actions { display: flex; gap: 0.375rem; margin-top: 0.375rem; }
    .file-btn { padding: 0.25rem 0.625rem; font-size: 0.7rem; border-radius: 1rem; border: none; cursor: pointer; }
    .message-wrapper.own .file-btn { background: rgba(255, 255, 255, 0.2); color: white; }
    .message-wrapper.other .file-btn { background: var(--accent-light); color: var(--accent); }

    .typing-indicator {
      padding: 0.375rem 0.75rem;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    .typing-content {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 0.375rem;
      color: var(--text-muted);
      font-size: 0.8rem;
    }
    .typing-dots { display: flex; gap: 0.2rem; }
    .typing-dot {
      width: 0.4rem;
      height: 0.4rem;
      background: var(--accent);
      border-radius: 50%;
      animation: bounce 1s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .typing-dot:nth-child(3) { animation-delay: 0.3s; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

    .input-area {
      background: var(--input-area-bg);
      border-top: 1px solid var(--border-color);
      padding: 0.5rem 0.75rem;
      flex-shrink: 0;
    }
    .input-container {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }
    .attach-btn {
      background: none;
      border: none;
      font-size: 1.25rem;
      padding: 0.5rem;
      cursor: pointer;
      border-radius: 50%;
      color: var(--text-muted);
      flex-shrink: 0;
    }
    .attach-btn:hover { background: var(--accent-light); color: var(--accent); }

    .message-input {
      flex: 1;
      padding: 0.625rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 1.5rem;
      font-size: 16px;
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      min-width: 0;
      -webkit-appearance: none;
    }
    .message-input:focus { border-color: var(--accent); }
    .message-input::placeholder { color: var(--text-muted); }

    .send-btn {
      background: var(--button-bg);
      color: white;
      border: none;
      padding: 0.625rem 1rem;
      border-radius: 1.5rem;
      font-weight: 600;
      cursor: pointer;
      flex-shrink: 0;
      font-size: 0.875rem;
    }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 1000;
    }
    .modal-actions { position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem; }
    .modal-btn {
      background: white;
      color: #333;
      border: none;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-weight: 500;
      cursor: pointer;
      font-size: 0.875rem;
    }
    .modal-content {
      max-width: 100%;
      max-height: 85vh;
      overflow: auto;
      background: white;
      border-radius: 0.5rem;
    }
    .modal-content img { max-width: 100%; max-height: 80vh; display: block; }
    .modal-content iframe { width: 90vw; max-width: 900px; height: 80vh; border: none; }

    .secure-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: rgba(255,255,255,0.2);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-size: 0.625rem;
      margin-left: 0.5rem;
    }

    .hidden { display: none !important; }

    @media (max-width: 600px) {
      .welcome-card, .form-card { margin: 0.5rem; padding: 1.25rem; }
      .message-bubble { max-width: 90%; }
      .header { padding: 0.625rem 0.75rem; }
      .header-left h1 { font-size: 0.9375rem; }
      .btn-small { padding: 0.25rem 0.5rem; font-size: 0.7rem; }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ========== YOUR FIREBASE CONFIG ==========
    var firebaseConfig = {
      apiKey: "AIzaSyAewTjQoPnklDMupxmR23PbdhahQtGHyJc",
      authDomain: "shared-space-678ec.firebaseapp.com",
      databaseURL: "https://shared-space-678ec-default-rtdb.firebaseio.com",
      projectId: "shared-space-678ec",
      storageBucket: "shared-space-678ec.firebasestorage.app",
      messagingSenderId: "8949280263",
      appId: "1:8949280263:web:43b538d62d9b9cde7bc4a2"
    };
    // ==========================================

    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    var MAX_FILE_SIZE = 10 * 1024 * 1024;
    var STORAGE_PREFIX = 'shared_space_';

    var state = {
      screen: 'welcome',
      username: '',
      passcode: '',
      messages: [],
      typingUsers: {},
      uploadingFile: false,
      previewFile: null,
      darkMode: false,
      spaceCreated: false,
      onlineUsers: 0
    };

    var typingTimeout = null;

    var storage = {
      get: function(key) { try { return localStorage.getItem(STORAGE_PREFIX + key); } catch (e) { return null; } },
      set: function(key, value) { try { localStorage.setItem(STORAGE_PREFIX + key, value); } catch (e) {} },
      delete: function(key) { try { localStorage.removeItem(STORAGE_PREFIX + key); } catch (e) {} }
    };

    function formatTime(ts) { return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
    function formatFileSize(b) { if (b < 1024) return b + ' B'; if (b < 1024 * 1024) return (b / 1024).toFixed(1) + ' KB'; return (b / (1024 * 1024)).toFixed(2) + ' MB'; }
    function getFileIcon(t, n) {
      if (t && t.indexOf('image/') === 0) return 'üñºÔ∏è';
      if (t === 'application/pdf' || (n && n.indexOf('.pdf') > -1)) return 'üìÑ';
      if ((t && t.indexOf('word') > -1) || (n && /\.(doc|docx)$/i.test(n))) return 'üìù';
      if ((t && t.indexOf('excel') > -1) || (n && /\.(xls|xlsx)$/i.test(n))) return 'üìä';
      return 'üìé';
    }
    function canPreview(t, n) { return (t && t.indexOf('image/') === 0) || t === 'application/pdf' || (n && n.indexOf('.pdf') > -1); }
    function escapeHtml(t) { var d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
    function generatePasscode() { var c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789', code = ''; for (var i = 0; i < 6; i++) code += c.charAt(Math.floor(Math.random() * c.length)); return code; }
    function sanitizeKey(s) { return s.replace(/[.#$\/\[\]]/g, '_'); }

    function toggleDarkMode() {
      state.darkMode = !state.darkMode;
      storage.set('darkMode', state.darkMode.toString());
      document.body.classList.toggle('dark-mode', state.darkMode);
      render();
    }

    function goToScreen(screen) { state.screen = screen; render(); }

    function subscribeToSpace() {
      var spaceRef = db.ref('spaces/' + state.passcode);
      spaceRef.child('messages').orderByChild('timestamp').limitToLast(100).on('value', function(snap) {
        state.messages = [];
        snap.forEach(function(c) { state.messages.push(c.val()); });
        renderMessages();
        scrollToBottom();
      });
      spaceRef.child('typing').on('value', function(snap) { state.typingUsers = snap.val() || {}; renderTypingIndicator(); });
      var presRef = spaceRef.child('presence/' + sanitizeKey(state.username));
      presRef.set(true);
      presRef.onDisconnect().remove();
      spaceRef.child('presence').on('value', function(snap) { state.onlineUsers = snap.numChildren(); renderHeader(); });
    }

    function unsubscribeFromSpace() {
      var spaceRef = db.ref('spaces/' + state.passcode);
      spaceRef.child('messages').off();
      spaceRef.child('typing').off();
      spaceRef.child('presence').off();
      spaceRef.child('presence/' + sanitizeKey(state.username)).remove();
    }

    function sendMessage(msg) { db.ref('spaces/' + state.passcode + '/messages').push(msg); clearTyping(); }
    function updateTyping() {
      db.ref('spaces/' + state.passcode + '/typing/' + sanitizeKey(state.username)).set(Date.now());
      if (typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(clearTyping, 3000);
    }
    function clearTyping() { db.ref('spaces/' + state.passcode + '/typing/' + sanitizeKey(state.username)).remove(); }

    function createSpace() {
      var name = document.getElementById('creator-name').value.trim();
      if (!name) { alert('Please enter your name'); return; }
      state.username = name;
      state.passcode = generatePasscode();
      state.spaceCreated = true;
      render();
    }

    function enterSpace() {
      state.screen = 'chat';
      storage.set('current-space', state.passcode);
      storage.set('current-username', state.username);
      subscribeToSpace();
      sendMessage({ id: Date.now(), type: 'system', text: state.username + ' joined the space', timestamp: Date.now() });
      render();
    }

    function joinSpace() {
      var code = document.getElementById('join-passcode').value.trim().toUpperCase();
      if (!code || code.length !== 6) { alert('Please enter a valid 6-character passcode'); return; }
      state.passcode = code;
      state.screen = 'enter-name';
      render();
    }

    function completeJoin() {
      var name = document.getElementById('joiner-name').value.trim();
      if (!name) { alert('Please enter your name'); return; }
      state.username = name;
      enterSpace();
    }

    function shareToWhatsApp() {
      var msg = 'üîê ' + state.username + ' invited you to a Shared Space!\n\nüì± Join here: ' + window.location.href + '\n\nüîë Passcode: ' + state.passcode;
      window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
    }

    function handleLeave() {
      unsubscribeFromSpace();
      storage.delete('current-space');
      storage.delete('current-username');
      state.screen = 'welcome';
      state.passcode = '';
      state.username = '';
      state.messages = [];
      state.spaceCreated = false;
      render();
    }

    function handleSendMessage() {
      var input = document.getElementById('message-input');
      var text = input.value.trim();
      if (!text) return;
      sendMessage({ id: Date.now(), type: 'text', sender: state.username, text: text, timestamp: Date.now() });
      input.value = '';
    }

    function handleFileUpload(e) {
      var file = e.target.files[0];
      if (!file) return;
      if (file.size > MAX_FILE_SIZE) { alert('File too large! Max 10MB.'); return; }
      state.uploadingFile = true;
      renderInputArea();
      var reader = new FileReader();
      reader.onload = function(ev) {
        sendMessage({ id: Date.now(), type: 'file', sender: state.username, fileName: file.name, fileType: file.type, fileSize: file.size, fileData: ev.target.result, timestamp: Date.now() });
        state.uploadingFile = false;
        renderInputArea();
      };
      reader.readAsDataURL(file);
      e.target.value = '';
    }

    function openPreview(id) { for (var i = 0; i < state.messages.length; i++) if (state.messages[i].id === id) { state.previewFile = state.messages[i]; break; } renderModal(); }
    function closePreview() { state.previewFile = null; renderModal(); }
    function handleDownload(data, name) { var a = document.createElement('a'); a.href = data; a.download = name; a.click(); }
    function scrollToBottom() { setTimeout(function() { var c = document.getElementById('messages-scroll'); if (c) c.scrollTop = c.scrollHeight; }, 100); }

    function renderMessages() {
      var c = document.getElementById('messages-container');
      if (!c) return;
      if (state.messages.length === 0) { c.innerHTML = '<div class="empty-state"><div class="icon">üîê</div><p>Secure space ready!<br>Start chatting.</p></div>'; return; }
      var h = '';
      for (var i = 0; i < state.messages.length; i++) h += renderMessage(state.messages[i]);
      c.innerHTML = h;
    }

    function renderMessage(m) {
      if (m.type === 'system') return '<div class="system-message"><span>' + escapeHtml(m.text) + '</span></div>';
      var own = m.sender === state.username;
      var cls = own ? 'own' : 'other';
      var content = '';
      if (m.type === 'text') content = '<div class="message-text">' + escapeHtml(m.text) + '</div>';
      else if (m.type === 'file') {
        var isImg = m.fileType && m.fileType.indexOf('image/') === 0;
        content = '<div class="file-info"><span class="file-icon">' + getFileIcon(m.fileType, m.fileName) + '</span><div class="file-details"><div class="file-name">' + escapeHtml(m.fileName) + '</div><div class="file-size">' + formatFileSize(m.fileSize) + '</div></div></div>';
        if (isImg) content += '<img src="' + m.fileData + '" class="file-preview-img" onclick="openPreview(' + m.id + ')">';
        content += '<div class="file-actions">';
        if (canPreview(m.fileType, m.fileName)) content += '<button class="file-btn" onclick="openPreview(' + m.id + ')">üëÅÔ∏è</button>';
        content += '<button class="file-btn" onclick="handleDownload(\'' + m.fileData + '\',\'' + escapeHtml(m.fileName) + '\')">‚¨áÔ∏è</button></div>';
      }
      var sender = own ? '' : '<div class="message-sender">' + escapeHtml(m.sender) + '</div>';
      return '<div class="message-wrapper ' + cls + '"><div class="message-bubble">' + sender + content + '<div class="message-time">' + formatTime(m.timestamp) + '</div></div></div>';
    }

    function renderTypingIndicator() {
      var c = document.getElementById('typing-area');
      if (!c) return;
      var users = [], now = Date.now();
      for (var u in state.typingUsers) if (now - state.typingUsers[u] < 5000 && u !== sanitizeKey(state.username)) users.push(u.replace(/_/g, ' '));
      if (users.length > 0) {
        c.innerHTML = '<div class="typing-indicator"><div class="typing-content"><div class="typing-dots"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div><span>' + users.join(', ') + ' typing...</span></div></div>';
      } else c.innerHTML = '';
    }

    function renderInputArea() {
      var c = document.getElementById('input-area');
      if (!c) return;
      c.innerHTML = '<div class="input-container"><input type="file" id="file-input" class="hidden" onchange="handleFileUpload(event)"><button class="attach-btn" onclick="document.getElementById(\'file-input\').click()">' + (state.uploadingFile ? '‚è≥' : 'üìé') + '</button><input type="text" class="message-input" id="message-input" placeholder="Type a message..."><button class="send-btn" onclick="handleSendMessage()">Send</button></div>';
      var inp = document.getElementById('message-input');
      if (inp) {
        inp.addEventListener('input', function(e) { if (e.target.value) updateTyping(); });
        inp.addEventListener('keypress', function(e) { if (e.key === 'Enter') { e.preventDefault(); handleSendMessage(); } });
      }
    }

    function renderHeader() {
      var c = document.getElementById('chat-header');
      if (!c) return;
      c.innerHTML = '<div class="header-content"><div class="header-left"><span class="icon">üîê</span><div><h1>Shared Space <span class="secure-badge">üîí</span></h1><p>' + escapeHtml(state.username) + ' ‚Ä¢ ' + state.passcode + '<span class="online-count"><span class="online-dot"></span> ' + state.onlineUsers + '</span></p></div></div><div class="header-right"><button class="btn-small" onclick="shareToWhatsApp()">üì±</button><button class="btn-small" onclick="toggleDarkMode()">' + (state.darkMode ? '‚òÄÔ∏è' : 'üåô') + '</button><button class="btn-small" onclick="handleLeave()">Leave</button></div></div>';
    }

    function renderModal() {
      var c = document.getElementById('modal-area');
      if (!c) return;
      if (!state.previewFile) { c.innerHTML = ''; return; }
      var isImg = state.previewFile.fileType && state.previewFile.fileType.indexOf('image/') === 0;
      var content = isImg ? '<img src="' + state.previewFile.fileData + '">' : '<iframe src="' + state.previewFile.fileData + '"></iframe>';
      c.innerHTML = '<div class="modal-overlay" onclick="if(event.target===this)closePreview()"><div class="modal-actions"><button class="modal-btn" onclick="handleDownload(\'' + state.previewFile.fileData + '\',\'' + escapeHtml(state.previewFile.fileName) + '\')">‚¨áÔ∏è</button><button class="modal-btn" onclick="closePreview()">‚úï</button></div><div class="modal-content">' + content + '</div></div>';
    }

    function render() {
      var h = '';
      if (state.screen === 'welcome') {
        h = '<div class="welcome-screen"><div class="welcome-card"><div class="welcome-card-header"><div class="icon">üîê</div><h1>Shared Space</h1><p>Secure real-time chat</p></div><div class="welcome-options"><button class="welcome-btn" onclick="goToScreen(\'create\')"><span class="btn-icon">‚ú®</span><div class="btn-text"><h3>Create New Space</h3><p>Start a private space</p></div></button><button class="welcome-btn" onclick="goToScreen(\'join\')"><span class="btn-icon">üö™</span><div class="btn-text"><h3>Join Space</h3><p>Enter passcode to join</p></div></button></div><div class="welcome-footer"><span>üîí Real-time sync</span><button class="theme-toggle" onclick="toggleDarkMode()">' + (state.darkMode ? '‚òÄÔ∏è' : 'üåô') + '</button></div></div></div>';
      } else if (state.screen === 'create') {
        if (state.spaceCreated) {
          h = '<div class="form-screen"><div class="form-card"><div class="form-header"><button class="back-btn" onclick="state.spaceCreated=false;goToScreen(\'welcome\')">‚Üê</button><h2>Space Created! üéâ</h2></div><div class="space-created-info"><h3>Your Passcode</h3><div class="passcode">' + state.passcode + '</div><small>Share this with others</small></div><button class="btn btn-whatsapp" onclick="shareToWhatsApp()">üì± Share via WhatsApp</button><button class="btn btn-primary" onclick="enterSpace()" style="margin-top:0.75rem">Enter Space ‚Üí</button></div></div>';
        } else {
          h = '<div class="form-screen"><div class="form-card"><div class="form-header"><button class="back-btn" onclick="goToScreen(\'welcome\')">‚Üê</button><h2>Create Space</h2></div><div class="form-group"><label>Your Name</label><input type="text" id="creator-name" placeholder="Enter name..." maxlength="30"></div><button class="btn btn-primary" onclick="createSpace()">Create Space</button></div></div>';
        }
      } else if (state.screen === 'join') {
        h = '<div class="form-screen"><div class="form-card"><div class="form-header"><button class="back-btn" onclick="goToScreen(\'welcome\')">‚Üê</button><h2>Join Space</h2></div><div class="form-group"><label>Passcode</label><input type="text" id="join-passcode" placeholder="ABC123" maxlength="6" style="text-transform:uppercase;letter-spacing:0.25rem;text-align:center;font-weight:600"></div><button class="btn btn-primary" onclick="joinSpace()">Continue</button></div></div>';
      } else if (state.screen === 'enter-name') {
        h = '<div class="form-screen"><div class="form-card"><div class="form-header"><button class="back-btn" onclick="goToScreen(\'join\')">‚Üê</button><h2>Join Space</h2></div><div class="space-created-info"><h3>üîë ' + state.passcode + '</h3><small>Joining this space</small></div><div class="form-group"><label>Your Name</label><input type="text" id="joiner-name" placeholder="Enter name..." maxlength="30"></div><button class="btn btn-primary" onclick="completeJoin()">Join ‚Üí</button></div></div>';
      } else if (state.screen === 'chat') {
        h = '<div class="chat-container"><div class="header" id="chat-header"></div><div class="messages-area" id="messages-scroll"><div class="messages-container" id="messages-container"></div></div><div id="typing-area"></div><div class="input-area" id="input-area"></div><div id="modal-area"></div></div>';
      }
      document.getElementById('app').innerHTML = h;
      if (state.screen === 'chat') { renderHeader(); renderMessages(); renderTypingIndicator(); renderInputArea(); scrollToBottom(); }
      ['creator-name', 'join-passcode', 'joiner-name'].forEach(function(id) {
        var inp = document.getElementById(id);
        if (inp) inp.addEventListener('keypress', function(e) { if (e.key === 'Enter') { e.preventDefault(); if (id === 'creator-name') createSpace(); else if (id === 'join-passcode') joinSpace(); else completeJoin(); } });
      });
    }

    function init() {
      if (storage.get('darkMode') === 'true') { state.darkMode = true; document.body.classList.add('dark-mode'); }
      var sp = storage.get('current-space'), un = storage.get('current-username');
      if (sp && un) { state.passcode = sp; state.username = un; state.screen = 'chat'; subscribeToSpace(); }
      render();
    }

    init();
  </script>
</body>
</html>
