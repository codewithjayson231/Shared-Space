<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0061D5">
  <title>Shared Space - Secure Chat & File Sharing</title>
  
  <!-- Firebase SDK -->
    <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAewTjQoPnklDMupxmR23PbdhahQtGHyJc",
    authDomain: "shared-space-678ec.firebaseapp.com",
    databaseURL: "https://shared-space-678ec-default-rtdb.firebaseio.com",
    projectId: "shared-space-678ec",
    storageBucket: "shared-space-678ec.firebasestorage.app",
    messagingSenderId: "8949280263",
    appId: "1:8949280263:web:43b538d62d9b9cde7bc4a2"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
</script>

  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #0061D5;
      height: 100%;
      overflow: hidden;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
    }

    #app {
      height: 100%;
      overflow: hidden;
    }

    /* Light Mode Colors */
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f8f9fa;
      --bg-header: linear-gradient(135deg, #0061D5 0%, #0073e6 100%);
      --bg-page: #0061D5;
      --text-primary: #222222;
      --text-secondary: #4a4a4a;
      --text-muted: #767676;
      --border-color: #e8e8e8;
      --msg-own-bg: linear-gradient(135deg, #0061D5 0%, #0073e6 100%);
      --msg-other-bg: #f0f2f5;
      --input-bg: #ffffff;
      --input-area-bg: #ffffff;
      --button-bg: linear-gradient(135deg, #0061D5 0%, #0073e6 100%);
      --button-hover: linear-gradient(135deg, #0050b3 0%, #0061D5 100%);
      --accent: #0061D5;
      --accent-light: #e6f0ff;
      --accent-hover: #0050b3;
      --success: #25D366;
      --success-hover: #1fb855;
      --online: #22c55e;
    }

    /* Dark Mode Colors */
    body.dark-mode {
      --bg-primary: #1a1a2e;
      --bg-secondary: #252542;
      --bg-tertiary: #1f1f3a;
      --bg-header: linear-gradient(135deg, #0050b3 0%, #0061D5 100%);
      --bg-page: #1a1a2e;
      --text-primary: #ffffff;
      --text-secondary: #c4c4c4;
      --text-muted: #888888;
      --border-color: #3d3d5c;
      --msg-own-bg: linear-gradient(135deg, #0061D5 0%, #0073e6 100%);
      --msg-other-bg: #2d2d4a;
      --input-bg: #252542;
      --input-area-bg: #252542;
      --button-bg: linear-gradient(135deg, #0061D5 0%, #0073e6 100%);
      --button-hover: linear-gradient(135deg, #0050b3 0%, #0061D5 100%);
      --accent: #4da6ff;
      --accent-light: #1a3a5c;
      --accent-hover: #0073e6;
      --success: #25D366;
      --success-hover: #1fb855;
      background-color: #1a1a2e;
    }

    /* Welcome/Setup Screen */
    .welcome-screen {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      background: var(--bg-page);
      overflow: auto;
    }

    .welcome-card {
      background: var(--bg-secondary);
      border-radius: 1rem;
      padding: 1.5rem;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    }

    .welcome-card-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .welcome-card-header .icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
    }

    .welcome-card-header h1 {
      color: var(--text-primary);
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
    }

    .welcome-card-header p {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .welcome-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .welcome-btn {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      border: 2px solid var(--border-color);
      border-radius: 0.75rem;
      background: var(--bg-tertiary);
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .welcome-btn:hover {
      border-color: var(--accent);
      background: var(--accent-light);
    }

    .welcome-btn .btn-icon {
      font-size: 1.5rem;
    }

    .welcome-btn .btn-text h3 {
      color: var(--text-primary);
      font-size: 1rem;
      margin-bottom: 0.125rem;
    }

    .welcome-btn .btn-text p {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .welcome-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    .welcome-footer span {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .theme-toggle {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      padding: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1.25rem;
      line-height: 1;
    }

    /* Form Screens */
    .form-screen {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      background: var(--bg-page);
      overflow: auto;
    }

    .form-card {
      background: var(--bg-secondary);
      border-radius: 1rem;
      padding: 1.5rem;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    }

    .form-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .back-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      padding: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      color: var(--text-primary);
    }

    .form-header h2 {
      color: var(--text-primary);
      font-size: 1.25rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .form-group input {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      font-size: 16px;
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      -webkit-appearance: none;
    }

    .form-group input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 97, 213, 0.15);
    }

    .form-group input::placeholder {
      color: var(--text-muted);
    }

    .form-group small {
      display: block;
      color: var(--text-muted);
      font-size: 0.75rem;
      margin-top: 0.375rem;
    }

    .btn {
      display: inline-block;
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      width: 100%;
      -webkit-appearance: none;
    }

    .btn-primary {
      background: var(--button-bg);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--button-hover);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-whatsapp {
      background: var(--success);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .btn-whatsapp:hover {
      background: var(--success-hover);
    }

    .btn-small {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 0.375rem;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-small:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .space-created-info {
      background: var(--accent-light);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .space-created-info h3 {
      color: var(--accent);
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
    }

    .space-created-info .passcode {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.25rem;
      text-align: center;
      padding: 0.5rem;
      background: var(--bg-secondary);
      border-radius: 0.375rem;
      margin-bottom: 0.5rem;
    }

    .space-created-info small {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    /* Main Chat Layout */
    .chat-container {
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      overflow: hidden;
    }

    /* Header */
    .header {
      background: var(--bg-header);
      color: white;
      padding: 0.75rem 1rem;
      flex-shrink: 0;
    }

    .header-content {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .header-left .icon {
      font-size: 1.25rem;
    }

    .header-left h1 {
      font-size: 1rem;
      font-weight: 700;
    }

    .header-left p {
      font-size: 0.7rem;
      opacity: 0.9;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    .header-right .btn-small {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }

    .online-count {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.7rem;
      background: rgba(255,255,255,0.2);
      padding: 0.125rem 0.5rem;
      border-radius: 1rem;
      margin-left: 0.5rem;
    }

    .online-dot {
      width: 0.5rem;
      height: 0.5rem;
      background: var(--online);
      border-radius: 50%;
    }

    /* Messages Area */
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem;
      -webkit-overflow-scrolling: touch;
    }

    .messages-container {
      max-width: 900px;
      margin: 0 auto;
    }

    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--text-muted);
    }

    .empty-state .icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
    }

    /* Message Styles */
    .message-wrapper {
      margin-bottom: 0.5rem;
      display: flex;
    }

    .message-wrapper.own {
      justify-content: flex-end;
    }

    .message-wrapper.other {
      justify-content: flex-start;
    }

    .message-bubble {
      max-width: 85%;
      padding: 0.625rem 0.875rem;
      border-radius: 1rem;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .message-wrapper.own .message-bubble {
      background: var(--msg-own-bg);
      color: white;
      border-bottom-right-radius: 0.25rem;
    }

    .message-wrapper.other .message-bubble {
      background: var(--msg-other-bg);
      color: var(--text-primary);
      border-bottom-left-radius: 0.25rem;
    }

    .message-sender {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.125rem;
    }

    .message-text {
      word-wrap: break-word;
      line-height: 1.4;
      font-size: 0.9375rem;
    }

    .message-time {
      font-size: 0.625rem;
      margin-top: 0.25rem;
      opacity: 0.7;
    }

    .message-wrapper.own .message-time {
      color: rgba(255, 255, 255, 0.8);
    }

    .message-wrapper.other .message-time {
      color: var(--text-muted);
    }

    /* System Message */
    .system-message {
      text-align: center;
      margin-bottom: 0.5rem;
    }

    .system-message span {
      display: inline-block;
      padding: 0.25rem 0.625rem;
      background: var(--accent-light);
      color: var(--accent);
      font-size: 0.7rem;
      border-radius: 1rem;
      font-weight: 500;
    }

    /* File Message */
    .file-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.375rem;
    }

    .file-icon {
      font-size: 1.25rem;
    }

    .file-details {
      flex: 1;
      min-width: 0;
    }

    .file-name {
      font-weight: 500;
      font-size: 0.875rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-size {
      font-size: 0.7rem;
      opacity: 0.7;
    }

    .file-preview-img {
      max-height: 150px;
      border-radius: 0.5rem;
      margin: 0.375rem 0;
      cursor: pointer;
    }

    .file-preview-img:hover {
      opacity: 0.9;
    }

    .file-actions {
      display: flex;
      gap: 0.375rem;
      margin-top: 0.375rem;
    }

    .file-btn {
      padding: 0.25rem 0.625rem;
      font-size: 0.7rem;
      border-radius: 1rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .message-wrapper.own .file-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .message-wrapper.own .file-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .message-wrapper.other .file-btn {
      background: var(--accent-light);
      color: var(--accent);
    }

    .message-wrapper.other .file-btn:hover {
      background: #cce0ff;
    }

    /* Typing Indicator */
    .typing-indicator {
      padding: 0.375rem 0.75rem;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .typing-content {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 0.375rem;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .typing-dots {
      display: flex;
      gap: 0.2rem;
    }

    .typing-dot {
      width: 0.4rem;
      height: 0.4rem;
      background: var(--accent);
      border-radius: 50%;
      animation: bounce 1s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .typing-dot:nth-child(3) { animation-delay: 0.3s; }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    /* Input Area */
    .input-area {
      background: var(--input-area-bg);
      border-top: 1px solid var(--border-color);
      padding: 0.5rem 0.75rem;
      flex-shrink: 0;
    }

    .input-container {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    .attach-btn {
      background: none;
      border: none;
      font-size: 1.25rem;
      padding: 0.5rem;
      cursor: pointer;
      border-radius: 50%;
      transition: background 0.2s;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .attach-btn:hover {
      background: var(--accent-light);
      color: var(--accent);
    }

    .message-input {
      flex: 1;
      padding: 0.625rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 1.5rem;
      font-size: 16px;
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s;
      min-width: 0;
      -webkit-appearance: none;
    }

    .message-input:focus {
      border-color: var(--accent);
    }

    .message-input::placeholder {
      color: var(--text-muted);
    }

    .send-btn {
      background: var(--button-bg);
      color: white;
      border: none;
      padding: 0.625rem 1rem;
      border-radius: 1.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      font-size: 0.875rem;
    }

    .send-btn:hover:not(:disabled) {
      background: var(--button-hover);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Preview Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 1000;
    }

    .modal-actions {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    .modal-btn {
      background: white;
      color: #333;
      border: none;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-weight: 500;
      cursor: pointer;
      font-size: 0.875rem;
    }

    .modal-btn:hover {
      background: #f0f0f0;
    }

    .modal-content {
      max-width: 100%;
      max-height: 85vh;
      overflow: auto;
      background: white;
      border-radius: 0.5rem;
    }

    .modal-content img {
      max-width: 100%;
      max-height: 80vh;
      display: block;
    }

    .modal-content iframe {
      width: 90vw;
      max-width: 900px;
      height: 80vh;
      border: none;
    }

    /* Secure badge */
    .secure-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: rgba(255,255,255,0.2);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-size: 0.625rem;
      margin-left: 0.5rem;
    }

    /* Connection status */
    .connection-status {
      text-align: center;
      padding: 0.5rem;
      font-size: 0.75rem;
      background: #fef3c7;
      color: #92400e;
    }

    .connection-status.connected {
      background: #d1fae5;
      color: #065f46;
    }

    .connection-status.error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Hidden */
    .hidden {
      display: none !important;
    }

    /* Mobile Optimizations */
    @media (max-width: 600px) {
      .welcome-card, .form-card {
        margin: 0.5rem;
        padding: 1.25rem;
      }

      .message-bubble {
        max-width: 90%;
      }

      .header {
        padding: 0.625rem 0.75rem;
      }

      .header-left h1 {
        font-size: 0.9375rem;
      }

      .send-btn {
        padding: 0.625rem 0.875rem;
      }

      .modal-content iframe {
        width: 100%;
      }

      .btn-small {
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ============================================
    // üî• FIREBASE CONFIGURATION - REPLACE THIS!
    // ============================================
    // Go to Firebase Console > Project Settings > Your apps > Web app
    // Copy your config and paste it here:
    
    var firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    
    // ============================================
    
    // Initialize Firebase
    var firebaseReady = false;
    var db = null;
    
    try {
      if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        firebaseReady = true;
      }
    } catch (e) {
      console.error("Firebase init error:", e);
    }

    var MAX_FILE_SIZE = 10 * 1024 * 1024;
    var STORAGE_PREFIX = 'shared_space_';

    // State
    var state = {
      screen: 'welcome',
      username: '',
      passcode: '',
      spaceName: '',
      creatorName: '',
      isCreator: false,
      messages: [],
      newMessage: '',
      typingUsers: {},
      uploadingFile: false,
      previewFile: null,
      darkMode: false,
      spaceCreated: false,
      onlineUsers: 0,
      connected: false
    };

    var typingTimeout = null;
    var messagesListener = null;
    var typingListener = null;
    var presenceListener = null;

    // Local storage for preferences only
    var storage = {
      get: function(key) {
        try {
          return localStorage.getItem(STORAGE_PREFIX + key);
        } catch (e) { return null; }
      },
      set: function(key, value) {
        try {
          localStorage.setItem(STORAGE_PREFIX + key, value);
        } catch (e) {}
      },
      delete: function(key) {
        try {
          localStorage.removeItem(STORAGE_PREFIX + key);
        } catch (e) {}
      }
    };

    // Utility functions
    function formatTime(timestamp) {
      return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    function getFileIcon(fileType, fileName) {
      if (fileType && fileType.indexOf('image/') === 0) return 'üñºÔ∏è';
      if (fileType === 'application/pdf' || (fileName && fileName.indexOf('.pdf') > -1)) return 'üìÑ';
      if ((fileType && fileType.indexOf('word') > -1) || (fileName && /\.(doc|docx)$/i.test(fileName))) return 'üìù';
      if ((fileType && fileType.indexOf('excel') > -1) || (fileName && /\.(xls|xlsx)$/i.test(fileName))) return 'üìä';
      if ((fileType && fileType.indexOf('powerpoint') > -1) || (fileName && /\.(ppt|pptx)$/i.test(fileName))) return 'üìΩÔ∏è';
      if (fileType && fileType.indexOf('video/') === 0) return 'üé¨';
      if (fileType && fileType.indexOf('audio/') === 0) return 'üéµ';
      if (fileName && /\.(zip|rar|7z)$/i.test(fileName)) return 'üì¶';
      return 'üìé';
    }

    function canPreview(fileType, fileName) {
      return (fileType && fileType.indexOf('image/') === 0) || 
             fileType === 'application/pdf' || 
             (fileName && fileName.indexOf('.pdf') > -1);
    }

    function handleDownload(fileData, fileName) {
      var link = document.createElement('a');
      link.href = fileData;
      link.download = fileName;
      link.click();
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function generatePasscode() {
      var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      var code = '';
      for (var i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Dark mode
    function toggleDarkMode() {
      state.darkMode = !state.darkMode;
      storage.set('darkMode', state.darkMode.toString());
      if (state.darkMode) {
        document.body.classList.add('dark-mode');
      } else {
        document.body.classList.remove('dark-mode');
      }
      render();
    }

    // Screen navigation
    function goToScreen(screen) {
      state.screen = screen;
      render();
    }

    // Firebase functions
    function subscribeToSpace() {
      if (!firebaseReady || !state.passcode) return;

      var spaceRef = db.ref('spaces/' + state.passcode);

      // Listen for messages
      if (messagesListener) messagesListener();
      messagesListener = spaceRef.child('messages').orderByChild('timestamp').limitToLast(100).on('value', function(snapshot) {
        state.messages = [];
        snapshot.forEach(function(child) {
          state.messages.push(child.val());
        });
        renderMessages();
        scrollToBottom();
      });

      // Listen for typing
      if (typingListener) typingListener();
      typingListener = spaceRef.child('typing').on('value', function(snapshot) {
        state.typingUsers = snapshot.val() || {};
        renderTypingIndicator();
      });

      // Presence system
      var presenceRef = spaceRef.child('presence/' + state.username.replace(/[.#$\/\[\]]/g, '_'));
      presenceRef.set(true);
      presenceRef.onDisconnect().remove();

      // Count online users
      if (presenceListener) presenceListener();
      presenceListener = spaceRef.child('presence').on('value', function(snapshot) {
        state.onlineUsers = snapshot.numChildren();
        renderHeader();
      });

      state.connected = true;
    }

    function unsubscribeFromSpace() {
      if (!firebaseReady || !state.passcode) return;

      var spaceRef = db.ref('spaces/' + state.passcode);
      
      if (messagesListener) {
        spaceRef.child('messages').off('value', messagesListener);
        messagesListener = null;
      }
      if (typingListener) {
        spaceRef.child('typing').off('value', typingListener);
        typingListener = null;
      }
      if (presenceListener) {
        spaceRef.child('presence').off('value', presenceListener);
        presenceListener = null;
      }

      // Remove presence
      var presenceRef = spaceRef.child('presence/' + state.username.replace(/[.#$\/\[\]]/g, '_'));
      presenceRef.remove();
    }

    function sendMessageToFirebase(msg) {
      if (!firebaseReady) return;
      
      var spaceRef = db.ref('spaces/' + state.passcode + '/messages');
      spaceRef.push(msg);
      
      // Clear typing
      clearTypingIndicator();
    }

    function updateTypingIndicator() {
      if (!firebaseReady || !state.passcode || !state.username) return;

      var typingRef = db.ref('spaces/' + state.passcode + '/typing/' + state.username.replace(/[.#$\/\[\]]/g, '_'));
      typingRef.set(Date.now());

      // Auto-clear after 3 seconds
      if (typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(function() {
        clearTypingIndicator();
      }, 3000);
    }

    function clearTypingIndicator() {
      if (!firebaseReady || !state.passcode || !state.username) return;
      
      var typingRef = db.ref('spaces/' + state.passcode + '/typing/' + state.username.replace(/[.#$\/\[\]]/g, '_'));
      typingRef.remove();
    }

    // Space creation
    function createSpace() {
      var nameInput = document.getElementById('creator-name');
      var name = nameInput ? nameInput.value.trim() : '';
      if (!name) {
        alert('Please enter your name');
        return;
      }

      if (!firebaseReady) {
        alert('Firebase is not configured. Please add your Firebase config to the code.');
        return;
      }

      state.username = name;
      state.creatorName = name;
      state.isCreator = true;
      state.passcode = generatePasscode();
      state.spaceCreated = true;

      render();
    }

    function enterSpace() {
      if (!firebaseReady) {
        alert('Firebase is not configured. Please add your Firebase config to the code.');
        return;
      }

      state.screen = 'chat';
      storage.set('current-space', state.passcode);
      storage.set('current-username', state.username);

      // Subscribe to Firebase
      subscribeToSpace();

      // Send join message
      sendMessageToFirebase({
        id: Date.now(),
        type: 'system',
        text: state.username + ' joined the space',
        timestamp: Date.now()
      });

      render();
    }

    function joinSpace() {
      var passcodeInput = document.getElementById('join-passcode');
      var passcode = passcodeInput ? passcodeInput.value.trim().toUpperCase() : '';
      
      if (!passcode || passcode.length !== 6) {
        alert('Please enter a valid 6-character passcode');
        return;
      }

      if (!firebaseReady) {
        alert('Firebase is not configured. Please add your Firebase config to the code.');
        return;
      }

      state.passcode = passcode;
      state.screen = 'enter-name';
      render();
    }

    function completeJoin() {
      var nameInput = document.getElementById('joiner-name');
      var name = nameInput ? nameInput.value.trim() : '';
      if (!name) {
        alert('Please enter your name');
        return;
      }

      state.username = name;
      state.isCreator = false;
      enterSpace();
    }

    function shareToWhatsApp() {
      var message = 'üîê ' + state.username + ' invited you to a Shared Space!\n\n' +
        'üì± Join here: ' + window.location.href + '\n\n' +
        'üîë Passcode: ' + state.passcode + '\n\n' +
        'Enter the passcode when you join to access the private space.';
      
      var url = 'https://wa.me/?text=' + encodeURIComponent(message);
      window.open(url, '_blank');
    }

    // Actions
    function handleLeave() {
      unsubscribeFromSpace();
      storage.delete('current-space');
      storage.delete('current-username');
      state.screen = 'welcome';
      state.passcode = '';
      state.username = '';
      state.messages = [];
      state.spaceCreated = false;
      state.connected = false;
      render();
    }

    function handleSendMessage() {
      var input = document.getElementById('message-input');
      var text = input ? input.value.trim() : '';
      if (!text) return;

      sendMessageToFirebase({
        id: Date.now(),
        type: 'text',
        sender: state.username,
        text: text,
        timestamp: Date.now()
      });

      input.value = '';
      state.newMessage = '';
    }

    function handleFileUpload(e) {
      var file = e.target.files ? e.target.files[0] : null;
      if (!file) return;

      if (file.size > MAX_FILE_SIZE) {
        alert('File too large! Maximum size is 10MB. Your file is ' + (file.size / 1024 / 1024).toFixed(2) + 'MB');
        return;
      }

      state.uploadingFile = true;
      renderInputArea();

      var reader = new FileReader();
      reader.onload = function(event) {
        sendMessageToFirebase({
          id: Date.now(),
          type: 'file',
          sender: state.username,
          fileName: file.name,
          fileType: file.type,
          fileSize: file.size,
          fileData: event.target.result,
          timestamp: Date.now()
        });
        state.uploadingFile = false;
        renderInputArea();
      };
      reader.onerror = function() {
        alert('Failed to read file');
        state.uploadingFile = false;
        renderInputArea();
      };
      reader.readAsDataURL(file);
      e.target.value = '';
    }

    function openPreview(msgId) {
      for (var i = 0; i < state.messages.length; i++) {
        if (state.messages[i].id === msgId) {
          state.previewFile = state.messages[i];
          break;
        }
      }
      renderModal();
    }

    function closePreview() {
      state.previewFile = null;
      renderModal();
    }

    function scrollToBottom() {
      setTimeout(function() {
        var container = document.getElementById('messages-scroll');
        if (container) container.scrollTop = container.scrollHeight;
      }, 100);
    }

    // Partial renders
    function renderMessages() {
      var container = document.getElementById('messages-container');
      if (!container) return;

      var messagesHtml = '';
      if (state.messages.length === 0) {
        messagesHtml = '<div class="empty-state"><div class="icon">üîê</div><p>Secure space ready!<br>Start chatting or share files.</p></div>';
      } else {
        for (var i = 0; i < state.messages.length; i++) {
          messagesHtml += renderMessage(state.messages[i]);
        }
      }
      container.innerHTML = messagesHtml;
    }

    function renderTypingIndicator() {
      var container = document.getElementById('typing-area');
      if (!container) return;

      var typingUsers = [];
      var now = Date.now();
      for (var user in state.typingUsers) {
        if (state.typingUsers.hasOwnProperty(user) && now - state.typingUsers[user] < 5000 && user !== state.username.replace(/[.#$\/\[\]]/g, '_')) {
          typingUsers.push(user.replace(/_/g, ' '));
        }
      }

      if (typingUsers.length > 0) {
        var typingText = typingUsers.length === 1 
          ? typingUsers[0] + ' is typing...' 
          : typingUsers.join(', ') + ' are typing...';
        container.innerHTML = '<div class="typing-indicator">' +
          '<div class="typing-content">' +
            '<div class="typing-dots">' +
              '<span class="typing-dot"></span>' +
              '<span class="typing-dot"></span>' +
              '<span class="typing-dot"></span>' +
            '</div>' +
            '<span>' + typingText + '</span>' +
          '</div>' +
        '</div>';
      } else {
        container.innerHTML = '';
      }
    }

    function renderInputArea() {
      var container = document.getElementById('input-area');
      if (!container) return;

      container.innerHTML = '<div class="input-container">' +
        '<input type="file" id="file-input" class="hidden" onchange="handleFileUpload(event)">' +
        '<button class="attach-btn" onclick="document.getElementById(\'file-input\').click()"' + (state.uploadingFile ? ' disabled' : '') + '>' +
          (state.uploadingFile ? '‚è≥' : 'üìé') +
        '</button>' +
        '<input type="text" class="message-input" id="message-input" placeholder="Type a message..." autocomplete="off" autocorrect="on">' +
        '<button class="send-btn" onclick="handleSendMessage()">Send</button>' +
      '</div>';

      setupInputListeners();
    }

    function renderHeader() {
      var container = document.getElementById('chat-header');
      if (!container) return;

      container.innerHTML = '<div class="header-content">' +
        '<div class="header-left">' +
          '<span class="icon">üîê</span>' +
          '<div>' +
            '<h1>Shared Space <span class="secure-badge">üîí Secure</span></h1>' +
            '<p>' + escapeHtml(state.username) + ' ‚Ä¢ Code: ' + state.passcode + 
            '<span class="online-count"><span class="online-dot"></span> ' + state.onlineUsers + ' online</span></p>' +
          '</div>' +
        '</div>' +
        '<div class="header-right">' +
          '<button class="btn-small" onclick="shareToWhatsApp()" title="Invite">üì±</button>' +
          '<button class="btn-small" onclick="toggleDarkMode()">' + (state.darkMode ? '‚òÄÔ∏è' : 'üåô') + '</button>' +
          '<button class="btn-small" onclick="handleLeave()">Leave</button>' +
        '</div>' +
      '</div>';
    }

    function renderModal() {
      var container = document.getElementById('modal-area');
      if (!container) return;

      if (!state.previewFile) {
        container.innerHTML = '';
        return;
      }

      var isImage = state.previewFile.fileType && state.previewFile.fileType.indexOf('image/') === 0;
      var contentHtml = isImage 
        ? '<img src="' + state.previewFile.fileData + '" alt="' + escapeHtml(state.previewFile.fileName) + '">'
        : '<iframe src="' + state.previewFile.fileData + '" title="' + escapeHtml(state.previewFile.fileName) + '"></iframe>';

      container.innerHTML = '<div class="modal-overlay" onclick="if(event.target === this) closePreview()">' +
        '<div class="modal-actions">' +
          '<button class="modal-btn" onclick="handleDownload(\'' + state.previewFile.fileData + '\', \'' + escapeHtml(state.previewFile.fileName).replace(/'/g, "\\'") + '\')">‚¨áÔ∏è Download</button>' +
          '<button class="modal-btn" onclick="closePreview()">‚úï Close</button>' +
        '</div>' +
        '<div class="modal-content">' +
          contentHtml +
        '</div>' +
      '</div>';
    }

    function setupInputListeners() {
      var messageInput = document.getElementById('message-input');
      if (messageInput) {
        messageInput.addEventListener('input', function(e) {
          state.newMessage = e.target.value;
          if (e.target.value) updateTypingIndicator();
        });
        messageInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            handleSendMessage();
          }
        });
      }
    }

    // Render functions
    function renderMessage(msg) {
      if (msg.type === 'system') {
        return '<div class="system-message"><span>' + escapeHtml(msg.text) + '</span></div>';
      }

      var isOwn = msg.sender === state.username;
      var wrapperClass = isOwn ? 'own' : 'other';

      var content = '';
      if (msg.type === 'text') {
        content = '<div class="message-text">' + escapeHtml(msg.text) + '</div>';
      } else if (msg.type === 'file') {
        var isImage = msg.fileType && msg.fileType.indexOf('image/') === 0;
        content = '<div class="file-info">' +
            '<span class="file-icon">' + getFileIcon(msg.fileType, msg.fileName) + '</span>' +
            '<div class="file-details">' +
              '<div class="file-name">' + escapeHtml(msg.fileName) + '</div>' +
              '<div class="file-size">' + formatFileSize(msg.fileSize) + '</div>' +
            '</div>' +
          '</div>';
        
        if (isImage) {
          content += '<img src="' + msg.fileData + '" alt="' + escapeHtml(msg.fileName) + '" class="file-preview-img" onclick="openPreview(' + msg.id + ')">';
        }
        
        content += '<div class="file-actions">';
        if (canPreview(msg.fileType, msg.fileName)) {
          content += '<button class="file-btn" onclick="openPreview(' + msg.id + ')">üëÅÔ∏è View</button>';
        }
        content += '<button class="file-btn" onclick="handleDownload(\'' + msg.fileData + '\', \'' + escapeHtml(msg.fileName).replace(/'/g, "\\'") + '\')">‚¨áÔ∏è</button>';
        content += '</div>';
      }

      var senderHtml = isOwn ? '' : '<div class="message-sender">' + escapeHtml(msg.sender) + '</div>';

      return '<div class="message-wrapper ' + wrapperClass + '">' +
        '<div class="message-bubble">' +
          senderHtml +
          content +
          '<div class="message-time">' + formatTime(msg.timestamp) + '</div>' +
        '</div>' +
      '</div>';
    }

    function renderWelcomeScreen() {
      var configWarning = '';
      if (!firebaseReady) {
        configWarning = '<div style="background: #fee2e2; color: #991b1b; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.8rem;">' +
          '‚ö†Ô∏è Firebase not configured. Edit index.html and add your Firebase config to enable real-time sync.' +
        '</div>';
      }

      return '<div class="welcome-screen">' +
        '<div class="welcome-card">' +
          '<div class="welcome-card-header">' +
            '<div class="icon">üîê</div>' +
            '<h1>Shared Space</h1>' +
            '<p>Secure chat & file sharing</p>' +
          '</div>' +
          configWarning +
          '<div class="welcome-options">' +
            '<button class="welcome-btn" onclick="goToScreen(\'create\')">' +
              '<span class="btn-icon">‚ú®</span>' +
              '<div class="btn-text">' +
                '<h3>Create New Space</h3>' +
                '<p>Start a private space and invite others</p>' +
              '</div>' +
            '</button>' +
            '<button class="welcome-btn" onclick="goToScreen(\'join\')">' +
              '<span class="btn-icon">üö™</span>' +
              '<div class="btn-text">' +
                '<h3>Join Invited Space</h3>' +
                '<p>Enter passcode to join existing space</p>' +
              '</div>' +
            '</button>' +
          '</div>' +
          '<div class="welcome-footer">' +
            '<span>üîí Real-time sync</span>' +
            '<button class="theme-toggle" onclick="toggleDarkMode()">' + (state.darkMode ? '‚òÄÔ∏è' : 'üåô') + '</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    function renderCreateScreen() {
      if (state.spaceCreated) {
        return '<div class="form-screen">' +
          '<div class="form-card">' +
            '<div class="form-header">' +
              '<button class="back-btn" onclick="state.spaceCreated=false; goToScreen(\'welcome\')">‚Üê</button>' +
              '<h2>Space Created! üéâ</h2>' +
            '</div>' +
            '<div class="space-created-info">' +
              '<h3>Your Space Passcode</h3>' +
              '<div class="passcode">' + state.passcode + '</div>' +
              '<small>Share this passcode with people you want to invite</small>' +
            '</div>' +
            '<button class="btn btn-whatsapp" onclick="shareToWhatsApp()">' +
              '<span>üì±</span> Share via WhatsApp' +
            '</button>' +
            '<button class="btn btn-primary" onclick="enterSpace()" style="margin-top: 0.75rem;">' +
              'Enter Space ‚Üí' +
            '</button>' +
          '</div>' +
        '</div>';
      }

      return '<div class="form-screen">' +
        '<div class="form-card">' +
          '<div class="form-header">' +
            '<button class="back-btn" onclick="goToScreen(\'welcome\')">‚Üê</button>' +
            '<h2>Create New Space</h2>' +
          '</div>' +
          '<div class="form-group">' +
            '<label>Your Name</label>' +
            '<input type="text" id="creator-name" placeholder="Enter your name..." maxlength="30" autocomplete="name">' +
            '<small>This will be shown to others in the space</small>' +
          '</div>' +
          '<button class="btn btn-primary" onclick="createSpace()">Create Secure Space</button>' +
        '</div>' +
      '</div>';
    }

    function renderJoinScreen() {
      return '<div class="form-screen">' +
        '<div class="form-card">' +
          '<div class="form-header">' +
            '<button class="back-btn" onclick="goToScreen(\'welcome\')">‚Üê</button>' +
            '<h2>Join Invited Space</h2>' +
          '</div>' +
          '<div class="form-group">' +
            '<label>Space Passcode</label>' +
            '<input type="text" id="join-passcode" placeholder="Enter 6-character code..." maxlength="6" style="text-transform: uppercase; letter-spacing: 0.25rem; text-align: center; font-weight: 600;" autocomplete="off">' +
            '<small>Enter the passcode shared by the space creator</small>' +
          '</div>' +
          '<button class="btn btn-primary" onclick="joinSpace()">Continue</button>' +
        '</div>' +
      '</div>';
    }

    function renderEnterNameScreen() {
      return '<div class="form-screen">' +
        '<div class="form-card">' +
          '<div class="form-header">' +
            '<button class="back-btn" onclick="goToScreen(\'join\')">‚Üê</button>' +
            '<h2>Join Space</h2>' +
          '</div>' +
          '<div class="space-created-info">' +
            '<h3>üîë Passcode: ' + state.passcode + '</h3>' +
            '<small>You\'re joining this private space</small>' +
          '</div>' +
          '<div class="form-group">' +
            '<label>Your Name</label>' +
            '<input type="text" id="joiner-name" placeholder="Enter your name..." maxlength="30" autocomplete="name">' +
            '<small>This will be shown to others in the space</small>' +
          '</div>' +
          '<button class="btn btn-primary" onclick="completeJoin()">Join Space ‚Üí</button>' +
        '</div>' +
      '</div>';
    }

    function renderChatScreen() {
      return '<div class="chat-container">' +
        '<div class="header" id="chat-header"></div>' +
        '<div class="messages-area" id="messages-scroll">' +
          '<div class="messages-container" id="messages-container"></div>' +
        '</div>' +
        '<div id="typing-area"></div>' +
        '<div class="input-area" id="input-area"></div>' +
        '<div id="modal-area"></div>' +
      '</div>';
    }

    function render() {
      var html = '';
      
      switch (state.screen) {
        case 'welcome':
          html = renderWelcomeScreen();
          break;
        case 'create':
          html = renderCreateScreen();
          break;
        case 'join':
          html = renderJoinScreen();
          break;
        case 'enter-name':
          html = renderEnterNameScreen();
          break;
        case 'chat':
          html = renderChatScreen();
          break;
        default:
          html = renderWelcomeScreen();
      }

      document.getElementById('app').innerHTML = html;

      // Setup after render
      if (state.screen === 'chat') {
        renderHeader();
        renderMessages();
        renderTypingIndicator();
        renderInputArea();
        scrollToBottom();
      }

      // Add enter key listeners for form inputs
      var inputs = ['creator-name', 'join-passcode', 'joiner-name'];
      inputs.forEach(function(id) {
        var input = document.getElementById(id);
        if (input) {
          input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              if (id === 'creator-name') createSpace();
              else if (id === 'join-passcode') joinSpace();
              else if (id === 'joiner-name') completeJoin();
            }
          });
        }
      });
    }

    // Initialize
    function init() {
      // Load dark mode
      if (storage.get('darkMode') === 'true') {
        state.darkMode = true;
        document.body.classList.add('dark-mode');
      }

      // Check for existing session
      var savedSpace = storage.get('current-space');
      var savedUsername = storage.get('current-username');
      
      if (savedSpace && savedUsername && firebaseReady) {
        state.passcode = savedSpace;
        state.username = savedUsername;
        state.screen = 'chat';
        subscribeToSpace();
      } else {
        state.screen = 'welcome';
      }

      render();
    }

    init();
  </script>
</body>
</html>
