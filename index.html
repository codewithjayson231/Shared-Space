<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0061D5">
  <title>Shared Space - Secure Chat & File Sharing</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; overflow: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #0061D5;
      height: 100%;
      overflow: hidden;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
    }
    #app { height: 100%; overflow: hidden; }

    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f8f9fa;
      --bg-header: linear-gradient(135deg, #0061D5 0%, #0073e6 100%);
      --bg-page: #0061D5;
      --text-primary: #222222;
      --text-secondary: #4a4a4a;
      --text-muted: #767676;
      --border-color: #e8e8e8;
      --msg-own-bg: linear-gradient(135deg, #0061D5 0%, #0073e6 100%);
      --msg-other-bg: #f0f2f5;
      --input-bg: #ffffff;
      --input-area-bg: #ffffff;
      --button-bg: linear-gradient(135deg, #0061D5 0%, #0073e6 100%);
      --button-hover: linear-gradient(135deg, #0050b3 0%, #0061D5 100%);
      --accent: #0061D5;
      --accent-light: #e6f0ff;
      --success: #25D366;
      --online: #22c55e;
      --danger: #ef4444;
    }

    body.dark-mode {
      --bg-primary: #1a1a2e;
      --bg-secondary: #252542;
      --bg-tertiary: #1f1f3a;
      --bg-header: linear-gradient(135deg, #0050b3 0%, #0061D5 100%);
      --bg-page: #1a1a2e;
      --text-primary: #ffffff;
      --text-secondary: #c4c4c4;
      --text-muted: #888888;
      --border-color: #3d3d5c;
      --msg-other-bg: #2d2d4a;
      --input-bg: #252542;
      --input-area-bg: #252542;
      --accent: #4da6ff;
      --accent-light: #1a3a5c;
      background-color: #1a1a2e;
    }

    .welcome-screen, .form-screen {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      background: var(--bg-page);
      overflow: auto;
    }

    .welcome-card, .form-card {
      background: var(--bg-secondary);
      border-radius: 1rem;
      padding: 1.5rem;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      max-height: 90vh;
      overflow-y: auto;
    }

    .welcome-card-header { text-align: center; margin-bottom: 1.5rem; }
    .welcome-card-header .icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
    .welcome-card-header h1 { color: var(--text-primary); font-size: 1.5rem; margin-bottom: 0.25rem; }
    .welcome-card-header p { color: var(--text-muted); font-size: 0.875rem; }

    .welcome-options { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem; }

    .welcome-btn {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      border: 2px solid var(--border-color);
      border-radius: 0.75rem;
      background: var(--bg-tertiary);
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }
    .welcome-btn:hover { border-color: var(--accent); background: var(--accent-light); }
    .welcome-btn .btn-icon { font-size: 1.5rem; }
    .welcome-btn .btn-text h3 { color: var(--text-primary); font-size: 1rem; margin-bottom: 0.125rem; }
    .welcome-btn .btn-text p { color: var(--text-muted); font-size: 0.75rem; }

    /* My Spaces Section */
    .my-spaces-section { margin-top: 1rem; }
    .my-spaces-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
    }
    .my-spaces-header h3 { color: var(--text-secondary); font-size: 0.875rem; font-weight: 600; }
    .my-spaces-header span { color: var(--text-muted); font-size: 0.75rem; }

    .space-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 0.75rem;
      background: var(--bg-tertiary);
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 0.5rem;
      border: 1px solid transparent;
    }
    .space-item:hover { border-color: var(--accent); background: var(--accent-light); }
    .space-item-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      flex-shrink: 0;
    }
    .space-item-info { flex: 1; min-width: 0; }
    .space-item-name { 
      color: var(--text-primary); 
      font-weight: 600; 
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .space-item-preview {
      color: var(--text-muted);
      font-size: 0.75rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 0.125rem;
    }
    .space-item-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.25rem;
    }
    .space-item-time { color: var(--text-muted); font-size: 0.65rem; }
    .space-item-badge {
      background: var(--accent);
      color: white;
      font-size: 0.65rem;
      font-weight: 600;
      padding: 0.125rem 0.5rem;
      border-radius: 1rem;
      min-width: 1.25rem;
      text-align: center;
    }

    .no-spaces {
      text-align: center;
      padding: 1rem;
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .welcome-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
      margin-top: 1rem;
    }
    .welcome-footer span { color: var(--text-muted); font-size: 0.75rem; }

    .theme-toggle {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      padding: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1.25rem;
      line-height: 1;
    }

    .form-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; }
    .back-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      padding: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      color: var(--text-primary);
    }
    .form-header h2 { color: var(--text-primary); font-size: 1.25rem; }

    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; color: var(--text-secondary); font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
    .form-group input {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      font-size: 16px;
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      -webkit-appearance: none;
    }
    .form-group input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0, 97, 213, 0.15); }
    .form-group input::placeholder { color: var(--text-muted); }
    .form-group small { display: block; color: var(--text-muted); font-size: 0.75rem; margin-top: 0.375rem; }

    .btn {
      display: inline-block;
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      width: 100%;
      -webkit-appearance: none;
    }
    .btn-primary { background: var(--button-bg); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--button-hover); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-whatsapp {
      background: var(--success);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    .btn-whatsapp:hover { background: #1fb855; }

    .btn-small {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 0.375rem;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-small:hover { background: rgba(255, 255, 255, 0.3); }

    .space-created-info {
      background: var(--accent-light);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .space-created-info h3 { color: var(--accent); font-size: 0.875rem; margin-bottom: 0.5rem; }
    .space-created-info .passcode {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.25rem;
      text-align: center;
      padding: 0.5rem;
      background: var(--bg-secondary);
      border-radius: 0.375rem;
      margin-bottom: 0.5rem;
    }
    .space-created-info .space-name-display {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      text-align: center;
      margin-bottom: 0.5rem;
    }
    .space-created-info small { color: var(--text-muted); font-size: 0.75rem; display: block; text-align: center; }

    .chat-container {
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      overflow: hidden;
    }

    /* Header: Avatar | Name+Passcode | SpaceName | Icons | Leave */
    .header {
      background: var(--bg-header);
      color: white;
      padding: 0.625rem 1rem;
      flex-shrink: 0;
    }
    .header-content {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
      flex-shrink: 0;
    }
    .header-user-info { 
      min-width: 0;
      flex-shrink: 0;
    }
    .header-username { 
      font-size: 0.875rem; 
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 80px;
    }
    .header-passcode { 
      font-size: 0.65rem; 
      opacity: 0.85;
      font-family: monospace;
    }
    
    .header-center {
      flex: 1;
      text-align: center;
      min-width: 0;
    }
    .header-space-name {
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .header-space-name .lock-icon {
      font-size: 0.875rem;
      opacity: 0.9;
    }
    .header-online {
      font-size: 0.65rem;
      opacity: 0.85;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
    }
    .header-online .online-dot {
      width: 6px;
      height: 6px;
      background: var(--online);
      border-radius: 50%;
    }
    
    .header-actions { 
      display: flex; 
      align-items: center; 
      gap: 0.375rem;
      flex-shrink: 0;
    }
    .header-actions .btn-small { 
      padding: 0.375rem; 
      width: 32px;
      height: 32px;
    }
    .btn-leave {
      background: rgba(255,255,255,0.15);
      padding: 0.375rem 0.625rem !important;
      width: auto !important;
      font-size: 0.7rem;
      font-weight: 500;
    }
    .btn-leave:hover {
      background: rgba(255,100,100,0.3);
    }

    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem;
      -webkit-overflow-scrolling: touch;
    }
    .messages-container { max-width: 900px; margin: 0 auto; }

    .empty-state { text-align: center; padding: 2rem 1rem; color: var(--text-muted); }
    .empty-state .icon { font-size: 2.5rem; margin-bottom: 0.75rem; }

    /* Message with swipe to reply */
    .message-wrapper { 
      margin-bottom: 0.5rem; 
      display: flex;
      position: relative;
      transition: transform 0.2s ease;
    }
    .message-wrapper.own { justify-content: flex-end; }
    .message-wrapper.other { justify-content: flex-start; }
    .message-wrapper.swiping { transition: none; }

    .reply-indicator {
      position: absolute;
      left: -40px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 1.25rem;
      color: var(--accent);
    }
    .message-wrapper.own .reply-indicator { left: auto; right: -40px; }
    .message-wrapper.show-reply .reply-indicator { opacity: 1; }

    .message-bubble {
      max-width: 85%;
      padding: 0.625rem 0.875rem;
      border-radius: 1rem;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      position: relative;
    }
    .message-wrapper.own .message-bubble {
      background: var(--msg-own-bg);
      color: white;
      border-bottom-right-radius: 0.25rem;
    }
    .message-wrapper.other .message-bubble {
      background: var(--msg-other-bg);
      color: var(--text-primary);
      border-bottom-left-radius: 0.25rem;
    }

    /* Reply Preview in message */
    .reply-preview {
      background: rgba(0,0,0,0.1);
      border-left: 3px solid rgba(255,255,255,0.5);
      padding: 0.375rem 0.5rem;
      margin-bottom: 0.375rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
    }
    .message-wrapper.other .reply-preview {
      background: rgba(0,0,0,0.05);
      border-left-color: var(--accent);
    }
    .reply-preview-sender { font-weight: 600; margin-bottom: 0.125rem; }
    .reply-preview-text { opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }

    .message-sender { font-size: 0.7rem; font-weight: 600; color: var(--accent); margin-bottom: 0.125rem; }
    .message-text { word-wrap: break-word; line-height: 1.4; font-size: 0.9375rem; }
    
    /* Message actions (edit) */
    .message-actions {
      position: absolute;
      top: -8px;
      right: 8px;
      display: none;
      gap: 0.25rem;
    }
    .message-wrapper.own:hover .message-actions { display: flex; }
    .message-action-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.7rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .message-action-btn:hover { background: var(--accent-light); }
    
    .message-edited {
      font-size: 0.6rem;
      opacity: 0.6;
      font-style: italic;
    }
    
    .message-footer {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.25rem;
      margin-top: 0.25rem;
    }
    .message-time { font-size: 0.625rem; opacity: 0.7; }
    .message-wrapper.own .message-time { color: rgba(255, 255, 255, 0.8); }
    .message-wrapper.other .message-time { color: var(--text-muted); }

    .message-status { font-size: 0.75rem; display: flex; align-items: center; }
    .message-wrapper.own .message-status { color: rgba(255, 255, 255, 0.8); }
    .status-delivered { opacity: 0.7; }
    .status-read { opacity: 1; color: #4fc3f7; }

    .system-message { text-align: center; margin-bottom: 0.5rem; }
    .system-message span {
      display: inline-block;
      padding: 0.25rem 0.625rem;
      background: var(--accent-light);
      color: var(--accent);
      font-size: 0.7rem;
      border-radius: 1rem;
      font-weight: 500;
    }

    .file-info { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.375rem; }
    .file-icon { font-size: 1.25rem; }
    .file-details { flex: 1; min-width: 0; }
    .file-name { font-weight: 500; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file-size { font-size: 0.7rem; opacity: 0.7; }
    .file-preview-img { max-height: 150px; border-radius: 0.5rem; margin: 0.375rem 0; cursor: pointer; }
    .file-actions { display: flex; gap: 0.375rem; margin-top: 0.375rem; }
    .file-btn { padding: 0.25rem 0.625rem; font-size: 0.7rem; border-radius: 1rem; border: none; cursor: pointer; }
    .message-wrapper.own .file-btn { background: rgba(255, 255, 255, 0.2); color: white; }
    .message-wrapper.other .file-btn { background: var(--accent-light); color: var(--accent); }

    /* Audio message with circle play/pause/stop icons */
    .audio-message {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 200px;
    }
    .audio-control-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid currentColor;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: transparent;
      transition: all 0.2s;
    }
    .audio-control-btn svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }
    .message-wrapper.own .audio-control-btn { 
      color: white; 
      border-color: rgba(255,255,255,0.6);
    }
    .message-wrapper.own .audio-control-btn:hover { 
      background: rgba(255,255,255,0.2); 
    }
    .message-wrapper.other .audio-control-btn { 
      color: var(--text-primary); 
      border-color: var(--text-primary);
    }
    .message-wrapper.other .audio-control-btn:hover { 
      background: var(--accent-light); 
    }
    
    .audio-progress-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .audio-progress {
      height: 4px;
      background: rgba(128,128,128,0.3);
      border-radius: 2px;
      overflow: hidden;
      cursor: pointer;
    }
    .audio-progress-bar {
      height: 100%;
      background: currentColor;
      border-radius: 2px;
      transition: width 0.1s;
      opacity: 0.8;
    }
    .audio-time {
      display: flex;
      justify-content: space-between;
      font-size: 0.65rem;
      opacity: 0.7;
    }

    .typing-indicator {
      padding: 0.375rem 0.75rem;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    .typing-content {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 0.375rem;
      color: var(--text-muted);
      font-size: 0.8rem;
    }
    .typing-dots { display: flex; gap: 0.2rem; }
    .typing-dot {
      width: 0.4rem;
      height: 0.4rem;
      background: var(--accent);
      border-radius: 50%;
      animation: bounce 1s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .typing-dot:nth-child(3) { animation-delay: 0.3s; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

    /* Reply bar */
    .reply-bar {
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border-color);
      padding: 0.5rem 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .reply-bar-content {
      flex: 1;
      border-left: 3px solid var(--accent);
      padding-left: 0.5rem;
    }
    .reply-bar-sender { font-size: 0.75rem; font-weight: 600; color: var(--accent); }
    .reply-bar-text { font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .reply-bar-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.25rem;
    }
    
    /* Edit bar */
    .edit-bar {
      background: var(--accent-light);
      border-top: 1px solid var(--border-color);
      padding: 0.5rem 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .edit-bar-content {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .edit-bar-icon { font-size: 1rem; }
    .edit-bar-text { font-size: 0.8rem; color: var(--accent); font-weight: 500; }
    .edit-bar-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.25rem;
    }

    .input-area {
      background: var(--input-area-bg);
      border-top: 1px solid var(--border-color);
      padding: 0.5rem 0.75rem;
      flex-shrink: 0;
    }
    .input-container {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }
    .attach-btn, .mic-btn {
      background: none;
      border: none;
      font-size: 1.25rem;
      padding: 0.5rem;
      cursor: pointer;
      border-radius: 50%;
      color: var(--text-muted);
      flex-shrink: 0;
      transition: all 0.2s;
    }
    .attach-btn:hover, .mic-btn:hover { background: var(--accent-light); color: var(--accent); }
    
    .mic-btn.recording {
      background: var(--danger);
      color: white;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .message-input {
      flex: 1;
      padding: 0.625rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 1.5rem;
      font-size: 16px;
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      min-width: 0;
      -webkit-appearance: none;
    }
    .message-input:focus { border-color: var(--accent); }
    .message-input::placeholder { color: var(--text-muted); }

    .send-btn {
      background: var(--button-bg);
      color: white;
      border: none;
      padding: 0.625rem 1rem;
      border-radius: 1.5rem;
      font-weight: 600;
      cursor: pointer;
      flex-shrink: 0;
      font-size: 0.875rem;
    }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Recording UI */
    .recording-ui {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      background: var(--bg-tertiary);
      padding: 0.5rem 1rem;
      border-radius: 1.5rem;
    }
    .recording-indicator {
      width: 10px;
      height: 10px;
      background: var(--danger);
      border-radius: 50%;
      animation: pulse 1s infinite;
    }
    .recording-time { font-size: 0.9rem; color: var(--text-primary); font-weight: 500; }
    .recording-cancel {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 1000;
    }
    .modal-actions { position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem; }
    .modal-btn {
      background: white;
      color: #333;
      border: none;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-weight: 500;
      cursor: pointer;
      font-size: 0.875rem;
    }
    .modal-content {
      max-width: 100%;
      max-height: 85vh;
      overflow: auto;
      background: white;
      border-radius: 0.5rem;
    }
    .modal-content img { max-width: 100%; max-height: 80vh; display: block; }
    .modal-content iframe { width: 90vw; max-width: 900px; height: 80vh; border: none; }

    .hidden { display: none !important; }

    /* Notification permission banner */
    .notification-banner {
      background: var(--accent-light);
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .notification-banner p { flex: 1; font-size: 0.8rem; color: var(--text-secondary); }
    .notification-banner button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.375rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      cursor: pointer;
    }

    @media (max-width: 600px) {
      .welcome-card, .form-card { margin: 0.5rem; padding: 1.25rem; }
      .message-bubble { max-width: 90%; }
      .header { padding: 0.5rem 0.75rem; }
      .header-username { max-width: 60px; font-size: 0.8rem; }
      .header-space-name { font-size: 0.9rem; }
      .btn-leave { font-size: 0.65rem; padding: 0.25rem 0.5rem !important; }
      .header-actions .btn-small { width: 28px; height: 28px; }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ========== FIREBASE CONFIG ==========
    var firebaseConfig = {
      apiKey: "AIzaSyAewTjQoPnklDMupxmR23PbdhahQtGHyJc",
      authDomain: "shared-space-678ec.firebaseapp.com",
      databaseURL: "https://shared-space-678ec-default-rtdb.firebaseio.com",
      projectId: "shared-space-678ec",
      storageBucket: "shared-space-678ec.firebasestorage.app",
      messagingSenderId: "8949280263",
      appId: "1:8949280263:web:43b538d62d9b9cde7bc4a2"
    };
    // =====================================

    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    var MAX_FILE_SIZE = 10 * 1024 * 1024;
    var STORAGE_PREFIX = 'shared_space_';
    var MAX_RECENT_SPACES = 10;

    // SVG Icons for audio controls (circle with play/pause/stop)
    var ICON_PLAY = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
    var ICON_PAUSE = '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
    var ICON_STOP = '<svg viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>';

    var state = {
      screen: 'welcome',
      username: '',
      passcode: '',
      spaceName: '',
      messages: [],
      typingUsers: {},
      uploadingFile: false,
      previewFile: null,
      darkMode: false,
      spaceCreated: false,
      onlineUsers: 0,
      mySpaces: [],
      replyingTo: null,
      editingMessage: null,
      isRecording: false,
      recordingTime: 0,
      mediaRecorder: null,
      audioChunks: [],
      recordingInterval: null,
      lastReadTimestamp: {},
      notificationPermission: 'default',
      playingAudio: null,
      audioElements: {}
    };

    var typingTimeout = null;
    var swipeStartX = 0;
    var swipeElement = null;
    var messageKeys = {};

    var storage = {
      get: function(key) { try { return localStorage.getItem(STORAGE_PREFIX + key); } catch (e) { return null; } },
      set: function(key, value) { try { localStorage.setItem(STORAGE_PREFIX + key, value); } catch (e) {} },
      delete: function(key) { try { localStorage.removeItem(STORAGE_PREFIX + key); } catch (e) {} },
      getJSON: function(key) { try { var v = localStorage.getItem(STORAGE_PREFIX + key); return v ? JSON.parse(v) : null; } catch (e) { return null; } },
      setJSON: function(key, value) { try { localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(value)); } catch (e) {} }
    };

    function loadMySpaces() { state.mySpaces = storage.getJSON('my-spaces') || []; }
    function saveMySpaces() { storage.setJSON('my-spaces', state.mySpaces); }

    function addOrUpdateSpace(passcode, spaceName, username, lastMessage, unreadCount) {
      var existing = state.mySpaces.findIndex(function(s) { return s.passcode === passcode; });
      var spaceData = { passcode: passcode, spaceName: spaceName, username: username, lastMessage: lastMessage || '', lastMessageTime: Date.now(), unreadCount: unreadCount || 0 };
      if (existing >= 0) { state.mySpaces[existing] = Object.assign(state.mySpaces[existing], spaceData); }
      else { state.mySpaces.unshift(spaceData); }
      if (state.mySpaces.length > MAX_RECENT_SPACES) { state.mySpaces = state.mySpaces.slice(0, MAX_RECENT_SPACES); }
      saveMySpaces();
    }

    function updateSpaceLastMessage(text) {
      var space = state.mySpaces.find(function(s) { return s.passcode === state.passcode; });
      if (space) { space.lastMessage = text; space.lastMessageTime = Date.now(); saveMySpaces(); }
    }

    function resetUnreadCount(passcode) {
      var space = state.mySpaces.find(function(s) { return s.passcode === passcode; });
      if (space) { space.unreadCount = 0; saveMySpaces(); }
    }

    function formatTime(ts) { return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
    function formatDate(ts) {
      var d = new Date(ts); var now = new Date();
      if (d.toDateString() === now.toDateString()) return formatTime(ts);
      var yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
      if (d.toDateString() === yesterday.toDateString()) return 'Yesterday';
      return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
    }
    function formatFileSize(b) { if (b < 1024) return b + ' B'; if (b < 1024 * 1024) return (b / 1024).toFixed(1) + ' KB'; return (b / (1024 * 1024)).toFixed(2) + ' MB'; }
    function formatRecordingTime(seconds) { var m = Math.floor(seconds / 60); var s = seconds % 60; return m + ':' + (s < 10 ? '0' : '') + s; }
    function getFileIcon(t, n) {
      if (t && t.indexOf('image/') === 0) return 'üñºÔ∏è';
      if (t === 'application/pdf' || (n && n.indexOf('.pdf') > -1)) return 'üìÑ';
      if ((t && t.indexOf('word') > -1) || (n && /\.(doc|docx)$/i.test(n))) return 'üìù';
      if ((t && t.indexOf('excel') > -1) || (n && /\.(xls|xlsx)$/i.test(n))) return 'üìä';
      return 'üìé';
    }
    function canPreview(t, n) { return (t && t.indexOf('image/') === 0) || t === 'application/pdf' || (n && n.indexOf('.pdf') > -1); }
    function escapeHtml(t) { var d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
    function generatePasscode() { var c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789', code = ''; for (var i = 0; i < 6; i++) code += c.charAt(Math.floor(Math.random() * c.length)); return code; }
    function sanitizeKey(s) { return s.replace(/[.#$\/\[\]]/g, '_'); }
    function getInitials(name) { return name.split(' ').map(function(w) { return w[0]; }).join('').toUpperCase().slice(0, 2); }

    function toggleDarkMode() { state.darkMode = !state.darkMode; storage.set('darkMode', state.darkMode.toString()); document.body.classList.toggle('dark-mode', state.darkMode); render(); }
    function goToScreen(screen) { state.screen = screen; render(); }

    function requestNotificationPermission() {
      if ('Notification' in window) { Notification.requestPermission().then(function(permission) { state.notificationPermission = permission; render(); }); }
    }

    function showNotification(spaceName, message, sender) {
      if (state.notificationPermission === 'granted' && document.hidden) {
        var notification = new Notification('New message from ' + spaceName, { body: sender + ': ' + message, icon: 'üîê', tag: 'shared-space-' + state.passcode });
        notification.onclick = function() { window.focus(); notification.close(); };
      }
    }

    function markMessagesAsRead() {
      if (!state.passcode || !state.username) return;
      db.ref('spaces/' + state.passcode + '/readReceipts/' + sanitizeKey(state.username)).set(Date.now());
    }

    function subscribeToReadReceipts() {
      db.ref('spaces/' + state.passcode + '/readReceipts').on('value', function(snap) { state.lastReadTimestamp = snap.val() || {}; renderMessages(); });
    }

    function isMessageRead(msg) {
      if (msg.sender !== state.username) return false;
      for (var user in state.lastReadTimestamp) { if (user !== sanitizeKey(state.username) && state.lastReadTimestamp[user] >= msg.timestamp) return true; }
      return false;
    }

    function subscribeToSpace() {
      var spaceRef = db.ref('spaces/' + state.passcode);
      spaceRef.child('info').once('value', function(snap) { var info = snap.val(); if (info && info.spaceName) { state.spaceName = info.spaceName; renderHeader(); } });
      spaceRef.child('messages').orderByChild('timestamp').limitToLast(100).on('value', function(snap) {
        var oldCount = state.messages.length;
        state.messages = []; messageKeys = {}; var lastMsg = null;
        snap.forEach(function(c) { var msg = c.val(); state.messages.push(msg); messageKeys[msg.id] = c.key; lastMsg = msg; });
        if (lastMsg && lastMsg.type !== 'system') { var preview = lastMsg.type === 'text' ? lastMsg.text : (lastMsg.type === 'audio' ? 'üé§ Voice' : 'üìé ' + lastMsg.fileName); updateSpaceLastMessage(preview.substring(0, 50)); }
        if (state.messages.length > oldCount && oldCount > 0) { var newMsg = state.messages[state.messages.length - 1]; if (newMsg.sender !== state.username && newMsg.type !== 'system') showNotification(state.spaceName, newMsg.type === 'text' ? newMsg.text : 'üìé File', newMsg.sender); }
        renderMessages(); scrollToBottom(); markMessagesAsRead();
      });
      spaceRef.child('typing').on('value', function(snap) { state.typingUsers = snap.val() || {}; renderTypingIndicator(); });
      var presRef = spaceRef.child('presence/' + sanitizeKey(state.username)); presRef.set(true); presRef.onDisconnect().remove();
      spaceRef.child('presence').on('value', function(snap) { state.onlineUsers = snap.numChildren(); renderHeader(); });
      subscribeToReadReceipts(); resetUnreadCount(state.passcode);
    }

    function unsubscribeFromSpace() {
      var spaceRef = db.ref('spaces/' + state.passcode);
      spaceRef.child('messages').off(); spaceRef.child('typing').off(); spaceRef.child('presence').off(); spaceRef.child('readReceipts').off();
      spaceRef.child('presence/' + sanitizeKey(state.username)).remove();
    }

    function sendMessage(msg) { db.ref('spaces/' + state.passcode + '/messages').push(msg); clearTyping(); state.replyingTo = null; state.editingMessage = null; }

    function editMessage(msgId, newText) {
      var firebaseKey = messageKeys[msgId]; if (!firebaseKey) return;
      db.ref('spaces/' + state.passcode + '/messages/' + firebaseKey).update({ text: newText, edited: true, editedAt: Date.now() });
      state.editingMessage = null; renderInputArea();
    }

    function startEditMessage(msg) {
      if (msg.type !== 'text' || msg.sender !== state.username) return;
      state.editingMessage = msg; state.replyingTo = null; renderInputArea();
      var input = document.getElementById('message-input'); if (input) { input.value = msg.text; input.focus(); }
    }

    function cancelEdit() { state.editingMessage = null; renderInputArea(); }

    function updateTyping() { db.ref('spaces/' + state.passcode + '/typing/' + sanitizeKey(state.username)).set(Date.now()); if (typingTimeout) clearTimeout(typingTimeout); typingTimeout = setTimeout(clearTyping, 3000); }
    function clearTyping() { db.ref('spaces/' + state.passcode + '/typing/' + sanitizeKey(state.username)).remove(); }

    function createSpace() {
      var spaceName = document.getElementById('space-name').value.trim();
      var name = document.getElementById('creator-name').value.trim();
      if (!spaceName) { alert('Please enter a space name'); return; }
      if (!name) { alert('Please enter your name'); return; }
      state.spaceName = spaceName; state.username = name; state.passcode = generatePasscode(); state.spaceCreated = true;
      db.ref('spaces/' + state.passcode + '/info').set({ spaceName: spaceName, createdBy: name, createdAt: Date.now() });
      render();
    }

    function enterSpace() {
      state.screen = 'chat';
      storage.set('current-space', state.passcode); storage.set('current-username', state.username); storage.set('current-spacename', state.spaceName);
      addOrUpdateSpace(state.passcode, state.spaceName, state.username);
      subscribeToSpace(); sendMessage({ id: Date.now(), type: 'system', text: state.username + ' joined the space', timestamp: Date.now() }); render();
    }

    function joinSpace() {
      var code = document.getElementById('join-passcode').value.trim().toUpperCase();
      if (!code || code.length !== 6) { alert('Please enter a valid 6-character passcode'); return; }
      state.passcode = code;
      db.ref('spaces/' + code + '/info').once('value', function(snap) { var info = snap.val(); state.spaceName = (info && info.spaceName) ? info.spaceName : 'Space ' + code; state.screen = 'enter-name'; render(); });
    }

    function completeJoin() { var name = document.getElementById('joiner-name').value.trim(); if (!name) { alert('Please enter your name'); return; } state.username = name; enterSpace(); }

    function rejoinSpace(space) {
      state.passcode = space.passcode; state.spaceName = space.spaceName; state.username = space.username; state.screen = 'chat';
      storage.set('current-space', state.passcode); storage.set('current-username', state.username); storage.set('current-spacename', state.spaceName);
      subscribeToSpace(); render();
    }

    function shareToWhatsApp() { var msg = 'üîê Join "' + state.spaceName + '" on Shared Space!\n\nüì± Link: ' + window.location.href + '\n\nüîë Passcode: ' + state.passcode; window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank'); }

    function handleLeave() {
      unsubscribeFromSpace(); storage.delete('current-space'); storage.delete('current-username'); storage.delete('current-spacename');
      state.screen = 'welcome'; state.passcode = ''; state.username = ''; state.spaceName = ''; state.messages = []; state.spaceCreated = false; state.replyingTo = null; state.editingMessage = null; loadMySpaces(); render();
    }

    function handleSendMessage() {
      var input = document.getElementById('message-input'); var text = input.value.trim(); if (!text) return;
      if (state.editingMessage) { editMessage(state.editingMessage.id, text); input.value = ''; return; }
      var msg = { id: Date.now(), type: 'text', sender: state.username, text: text, timestamp: Date.now() };
      if (state.replyingTo) { msg.replyTo = { id: state.replyingTo.id, sender: state.replyingTo.sender, text: state.replyingTo.type === 'text' ? state.replyingTo.text.substring(0, 100) : (state.replyingTo.type === 'audio' ? 'üé§ Voice' : 'üìé ' + state.replyingTo.fileName) }; }
      sendMessage(msg); input.value = ''; renderInputArea();
    }

    function handleFileUpload(e) {
      var file = e.target.files[0]; if (!file) return;
      if (file.size > MAX_FILE_SIZE) { alert('File too large! Max 10MB.'); return; }
      state.uploadingFile = true; renderInputArea();
      var reader = new FileReader();
      reader.onload = function(ev) {
        var msg = { id: Date.now(), type: 'file', sender: state.username, fileName: file.name, fileType: file.type, fileSize: file.size, fileData: ev.target.result, timestamp: Date.now() };
        if (state.replyingTo) { msg.replyTo = { id: state.replyingTo.id, sender: state.replyingTo.sender, text: state.replyingTo.type === 'text' ? state.replyingTo.text.substring(0, 100) : 'üìé ' + state.replyingTo.fileName }; }
        sendMessage(msg); state.uploadingFile = false; renderInputArea();
      };
      reader.readAsDataURL(file); e.target.value = '';
    }

    function startRecording() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { alert('Audio recording not supported'); return; }
      navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
        state.mediaRecorder = new MediaRecorder(stream); state.audioChunks = []; state.isRecording = true; state.recordingTime = 0;
        state.mediaRecorder.ondataavailable = function(e) { state.audioChunks.push(e.data); };
        state.mediaRecorder.onstop = function() { stream.getTracks().forEach(function(track) { track.stop(); }); };
        state.mediaRecorder.start();
        state.recordingInterval = setInterval(function() { state.recordingTime++; renderInputArea(); }, 1000);
        renderInputArea();
      }).catch(function(err) { alert('Microphone error: ' + err.message); });
    }

    function stopRecording(send) {
      if (!state.mediaRecorder) return; clearInterval(state.recordingInterval);
      if (send) {
        state.mediaRecorder.onstop = function() {
          var audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
          var reader = new FileReader();
          reader.onload = function(e) {
            var msg = { id: Date.now(), type: 'audio', sender: state.username, audioData: e.target.result, duration: state.recordingTime, timestamp: Date.now() };
            if (state.replyingTo) { msg.replyTo = { id: state.replyingTo.id, sender: state.replyingTo.sender, text: 'üé§ Voice' }; }
            sendMessage(msg); state.isRecording = false; state.recordingTime = 0; renderInputArea();
          };
          reader.readAsDataURL(audioBlob);
        };
      } else { state.mediaRecorder.onstop = function() { state.isRecording = false; state.recordingTime = 0; renderInputArea(); }; }
      state.mediaRecorder.stop(); state.mediaRecorder.stream.getTracks().forEach(function(track) { track.stop(); });
    }

    function toggleRecording() { if (state.isRecording) stopRecording(true); else startRecording(); }
    function cancelRecording() { stopRecording(false); }

    function playAudio(msgId, audioData, duration) {
      var btn = document.getElementById('audio-btn-' + msgId);
      var progressBar = document.getElementById('audio-progress-' + msgId);
      var currentTimeEl = document.getElementById('audio-current-' + msgId);
      if (state.playingAudio === msgId && state.audioElements[msgId]) { state.audioElements[msgId].pause(); btn.innerHTML = ICON_PLAY; state.playingAudio = null; return; }
      if (state.playingAudio && state.audioElements[state.playingAudio]) { state.audioElements[state.playingAudio].pause(); var oldBtn = document.getElementById('audio-btn-' + state.playingAudio); if (oldBtn) oldBtn.innerHTML = ICON_PLAY; }
      if (!state.audioElements[msgId]) state.audioElements[msgId] = new Audio(audioData);
      var audio = state.audioElements[msgId]; state.playingAudio = msgId; btn.innerHTML = ICON_PAUSE;
      audio.ontimeupdate = function() { var progress = (audio.currentTime / audio.duration) * 100; if (progressBar) progressBar.style.width = progress + '%'; if (currentTimeEl) currentTimeEl.textContent = formatRecordingTime(Math.floor(audio.currentTime)); };
      audio.onended = function() { btn.innerHTML = ICON_PLAY; if (progressBar) progressBar.style.width = '0%'; if (currentTimeEl) currentTimeEl.textContent = '0:00'; state.playingAudio = null; };
      audio.play();
    }

    function stopAudio(msgId) {
      if (state.audioElements[msgId]) {
        state.audioElements[msgId].pause(); state.audioElements[msgId].currentTime = 0;
        var btn = document.getElementById('audio-btn-' + msgId); var progressBar = document.getElementById('audio-progress-' + msgId); var currentTimeEl = document.getElementById('audio-current-' + msgId);
        if (btn) btn.innerHTML = ICON_PLAY; if (progressBar) progressBar.style.width = '0%'; if (currentTimeEl) currentTimeEl.textContent = '0:00'; state.playingAudio = null;
      }
    }

    function handleTouchStart(e, msgId) { swipeStartX = e.touches[0].clientX; swipeElement = e.currentTarget; }
    function handleTouchMove(e, msgId, isOwn) {
      if (!swipeElement) return; var diff = e.touches[0].clientX - swipeStartX; var maxSwipe = 80;
      if (isOwn) { if (diff < 0) { swipeElement.style.transform = 'translateX(' + Math.max(diff, -maxSwipe) + 'px)'; swipeElement.classList.add('swiping'); swipeElement.classList.toggle('show-reply', Math.abs(diff) > 50); } }
      else { if (diff > 0) { swipeElement.style.transform = 'translateX(' + Math.min(diff, maxSwipe) + 'px)'; swipeElement.classList.add('swiping'); swipeElement.classList.toggle('show-reply', diff > 50); } }
    }
    function handleTouchEnd(e, msg, isOwn) {
      if (!swipeElement) return; var diff = e.changedTouches[0].clientX - swipeStartX;
      swipeElement.classList.remove('swiping', 'show-reply'); swipeElement.style.transform = '';
      if ((isOwn && diff < -50) || (!isOwn && diff > 50)) setReplyTo(msg);
      swipeElement = null;
    }

    function setReplyTo(msg) { state.replyingTo = msg; state.editingMessage = null; renderInputArea(); var input = document.getElementById('message-input'); if (input) input.focus(); }
    function cancelReply() { state.replyingTo = null; renderInputArea(); }

    function openPreview(id) { for (var i = 0; i < state.messages.length; i++) if (state.messages[i].id === id) { state.previewFile = state.messages[i]; break; } renderModal(); }
    function closePreview() { state.previewFile = null; renderModal(); }
    function handleDownload(data, name) { var a = document.createElement('a'); a.href = data; a.download = name; a.click(); }
    function scrollToBottom() { setTimeout(function() { var c = document.getElementById('messages-scroll'); if (c) c.scrollTop = c.scrollHeight; }, 100); }

    function renderMessages() {
      var c = document.getElementById('messages-container'); if (!c) return;
      if (state.messages.length === 0) { c.innerHTML = '<div class="empty-state"><div class="icon">üîê</div><p>Secure space ready!<br>Start chatting.</p></div>'; return; }
      var h = ''; for (var i = 0; i < state.messages.length; i++) h += renderMessage(state.messages[i]); c.innerHTML = h;
    }

    function renderMessage(m) {
      if (m.type === 'system') return '<div class="system-message"><span>' + escapeHtml(m.text) + '</span></div>';
      var own = m.sender === state.username; var cls = own ? 'own' : 'other'; var isRead = isMessageRead(m);
      var replyHtml = m.replyTo ? '<div class="reply-preview"><div class="reply-preview-sender">' + escapeHtml(m.replyTo.sender) + '</div><div class="reply-preview-text">' + escapeHtml(m.replyTo.text) + '</div></div>' : '';
      var editBtn = (own && m.type === 'text') ? '<div class="message-actions"><button class="message-action-btn" onclick="startEditMessage(state.messages.find(function(x){return x.id===' + m.id + '}))">‚úèÔ∏è</button></div>' : '';
      var content = '';
      if (m.type === 'text') { var editedLabel = m.edited ? '<span class="message-edited">(edited)</span>' : ''; content = replyHtml + '<div class="message-text">' + escapeHtml(m.text) + ' ' + editedLabel + '</div>'; }
      else if (m.type === 'audio') {
        var isPlaying = state.playingAudio === m.id; var playIcon = isPlaying ? ICON_PAUSE : ICON_PLAY;
        content = replyHtml + '<div class="audio-message"><button class="audio-control-btn" id="audio-btn-' + m.id + '" onclick="playAudio(' + m.id + ', \'' + m.audioData + '\', ' + m.duration + ')">' + playIcon + '</button><div class="audio-progress-container"><div class="audio-progress"><div class="audio-progress-bar" id="audio-progress-' + m.id + '" style="width:0%"></div></div><div class="audio-time"><span id="audio-current-' + m.id + '">0:00</span><span>' + formatRecordingTime(m.duration) + '</span></div></div><button class="audio-control-btn" onclick="stopAudio(' + m.id + ')">' + ICON_STOP + '</button></div>';
      } else if (m.type === 'file') {
        var isImg = m.fileType && m.fileType.indexOf('image/') === 0;
        content = replyHtml + '<div class="file-info"><span class="file-icon">' + getFileIcon(m.fileType, m.fileName) + '</span><div class="file-details"><div class="file-name">' + escapeHtml(m.fileName) + '</div><div class="file-size">' + formatFileSize(m.fileSize) + '</div></div></div>';
        if (isImg) content += '<img src="' + m.fileData + '" class="file-preview-img" onclick="openPreview(' + m.id + ')">';
        content += '<div class="file-actions">'; if (canPreview(m.fileType, m.fileName)) content += '<button class="file-btn" onclick="openPreview(' + m.id + ')">üëÅÔ∏è</button>';
        content += '<button class="file-btn" onclick="handleDownload(\'' + m.fileData + '\',\'' + escapeHtml(m.fileName) + '\')">‚¨áÔ∏è</button></div>';
      }
      var statusHtml = own ? (isRead ? '<span class="message-status status-read" title="Read">‚úâÔ∏è‚úì</span>' : '<span class="message-status status-delivered" title="Delivered">‚úâÔ∏è</span>') : '';
      var sender = own ? '' : '<div class="message-sender">' + escapeHtml(m.sender) + '</div>';
      var footer = '<div class="message-footer"><span class="message-time">' + formatTime(m.timestamp) + '</span>' + statusHtml + '</div>';
      return '<div class="message-wrapper ' + cls + '" ontouchstart="handleTouchStart(event, ' + m.id + ')" ontouchmove="handleTouchMove(event, ' + m.id + ', ' + own + ')" ontouchend="handleTouchEnd(event, state.messages.find(function(x){return x.id===' + m.id + '}), ' + own + ')">' + editBtn + '<span class="reply-indicator">‚Ü©Ô∏è</span><div class="message-bubble">' + sender + content + footer + '</div></div>';
    }

    function renderTypingIndicator() {
      var c = document.getElementById('typing-area'); if (!c) return;
      var users = [], now = Date.now();
      for (var u in state.typingUsers) if (now - state.typingUsers[u] < 5000 && u !== sanitizeKey(state.username)) users.push(u.replace(/_/g, ' '));
      c.innerHTML = users.length > 0 ? '<div class="typing-indicator"><div class="typing-content"><div class="typing-dots"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div><span>' + users.join(', ') + ' typing...</span></div></div>' : '';
    }

    function renderInputArea() {
      var c = document.getElementById('input-area'); if (!c) return;
      var topBar = '';
      if (state.editingMessage) { topBar = '<div class="edit-bar"><div class="edit-bar-content"><span class="edit-bar-icon">‚úèÔ∏è</span><span class="edit-bar-text">Editing message</span></div><button class="edit-bar-close" onclick="cancelEdit()">‚úï</button></div>'; }
      else if (state.replyingTo) { var replyText = state.replyingTo.type === 'text' ? state.replyingTo.text : (state.replyingTo.type === 'audio' ? 'üé§ Voice' : 'üìé ' + state.replyingTo.fileName); topBar = '<div class="reply-bar"><div class="reply-bar-content"><div class="reply-bar-sender">' + escapeHtml(state.replyingTo.sender) + '</div><div class="reply-bar-text">' + escapeHtml(replyText.substring(0, 50)) + '</div></div><button class="reply-bar-close" onclick="cancelReply()">‚úï</button></div>'; }
      var inputHtml = '';
      if (state.isRecording) { inputHtml = '<div class="input-container"><div class="recording-ui"><span class="recording-indicator"></span><span class="recording-time">' + formatRecordingTime(state.recordingTime) + '</span><button class="recording-cancel" onclick="cancelRecording()">Cancel</button></div><button class="send-btn" onclick="stopRecording(true)">Send</button></div>'; }
      else { var sendBtnText = state.editingMessage ? 'Save' : 'Send'; inputHtml = '<div class="input-container"><input type="file" id="file-input" class="hidden" onchange="handleFileUpload(event)"><button class="attach-btn" onclick="document.getElementById(\'file-input\').click()">' + (state.uploadingFile ? '‚è≥' : 'üìé') + '</button><button class="mic-btn" onclick="toggleRecording()">üé§</button><input type="text" class="message-input" id="message-input" placeholder="Type a message..."><button class="send-btn" onclick="handleSendMessage()">' + sendBtnText + '</button></div>'; }
      c.innerHTML = topBar + inputHtml;
      var inp = document.getElementById('message-input');
      if (inp) { if (state.editingMessage) inp.value = state.editingMessage.text; inp.addEventListener('input', function(e) { if (e.target.value && !state.editingMessage) updateTyping(); }); inp.addEventListener('keypress', function(e) { if (e.key === 'Enter') { e.preventDefault(); handleSendMessage(); } }); }
    }

    function renderHeader() {
      var c = document.getElementById('chat-header'); if (!c) return;
      var avatarInitials = getInitials(state.username);
      c.innerHTML = '<div class="header-content"><div class="header-avatar">' + avatarInitials + '</div><div class="header-user-info"><div class="header-username">' + escapeHtml(state.username) + '</div><div class="header-passcode">' + state.passcode + '</div></div><div class="header-center"><div class="header-space-name"><span class="lock-icon">üîê</span> ' + escapeHtml(state.spaceName) + '</div><div class="header-online"><span class="online-dot"></span> ' + state.onlineUsers + ' online</div></div><div class="header-actions"><button class="btn-small" onclick="shareToWhatsApp()">üì±</button><button class="btn-small" onclick="toggleDarkMode()">' + (state.darkMode ? '‚òÄÔ∏è' : 'üåô') + '</button><button class="btn-small btn-leave" onclick="handleLeave()">Leave</button></div></div>';
    }

    function renderModal() {
      var c = document.getElementById('modal-area'); if (!c) return;
      if (!state.previewFile) { c.innerHTML = ''; return; }
      var isImg = state.previewFile.fileType && state.previewFile.fileType.indexOf('image/') === 0;
      var content = isImg ? '<img src="' + state.previewFile.fileData + '">' : '<iframe src="' + state.previewFile.fileData + '"></iframe>';
      c.innerHTML = '<div class="modal-overlay" onclick="if(event.target===this)closePreview()"><div class="modal-actions"><button class="modal-btn" onclick="handleDownload(\'' + state.previewFile.fileData + '\',\'' + escapeHtml(state.previewFile.fileName) + '\')">‚¨áÔ∏è</button><button class="modal-btn" onclick="closePreview()">‚úï</button></div><div class="modal-content">' + content + '</div></div>';
    }

    function renderMySpaces() {
      if (state.mySpaces.length === 0) return '<div class="no-spaces">No recent spaces</div>';
      var h = '';
      for (var i = 0; i < state.mySpaces.length; i++) { var s = state.mySpaces[i]; var badge = s.unreadCount > 0 ? '<span class="space-item-badge">' + s.unreadCount + '</span>' : ''; h += '<div class="space-item" onclick="rejoinSpace(state.mySpaces[' + i + '])"><div class="space-item-icon">' + getInitials(s.spaceName) + '</div><div class="space-item-info"><div class="space-item-name">' + escapeHtml(s.spaceName) + '</div><div class="space-item-preview">' + escapeHtml(s.lastMessage || 'No messages yet') + '</div></div><div class="space-item-meta"><span class="space-item-time">' + formatDate(s.lastMessageTime) + '</span>' + badge + '</div></div>'; }
      return h;
    }

    function render() {
      var h = '';
      if (state.screen === 'welcome') {
        var notificationBanner = ('Notification' in window && state.notificationPermission === 'default') ? '<div class="notification-banner"><p>üîî Enable notifications to know when you receive messages</p><button onclick="requestNotificationPermission()">Enable</button></div>' : '';
        h = '<div class="welcome-screen"><div class="welcome-card"><div class="welcome-card-header"><div class="icon">üîê</div><h1>Shared Space</h1><p>Secure real-time chat</p></div>' + notificationBanner + '<div class="welcome-options"><button class="welcome-btn" onclick="goToScreen(\'create\')"><span class="btn-icon">‚ú®</span><div class="btn-text"><h3>Create New Space</h3><p>Start a private space</p></div></button><button class="welcome-btn" onclick="goToScreen(\'join\')"><span class="btn-icon">üö™</span><div class="btn-text"><h3>Join Space</h3><p>Enter passcode to join</p></div></button></div><div class="my-spaces-section"><div class="my-spaces-header"><h3>üìÇ My Spaces</h3><span>' + state.mySpaces.length + ' spaces</span></div>' + renderMySpaces() + '</div><div class="welcome-footer"><span>üîí Real-time sync</span><button class="theme-toggle" onclick="toggleDarkMode()">' + (state.darkMode ? '‚òÄÔ∏è' : 'üåô') + '</button></div></div></div>';
      } else if (state.screen === 'create') {
        h = state.spaceCreated ? '<div class="form-screen"><div class="form-card"><div class="form-header"><button class="back-btn" onclick="state.spaceCreated=false;goToScreen(\'welcome\')">‚Üê</button><h2>Space Created! üéâ</h2></div><div class="space-created-info"><h3>Space Name</h3><div class="space-name-display">' + escapeHtml(state.spaceName) + '</div><h3>Your Passcode</h3><div class="passcode">' + state.passcode + '</div><small>Share this passcode with others to join</small></div><button class="btn btn-whatsapp" onclick="shareToWhatsApp()">üì± Share via WhatsApp</button><button class="btn btn-primary" onclick="enterSpace()" style="margin-top:0.75rem">Enter Space ‚Üí</button></div></div>' : '<div class="form-screen"><div class="form-card"><div class="form-header"><button class="back-btn" onclick="goToScreen(\'welcome\')">‚Üê</button><h2>Create Space</h2></div><div class="form-group"><label>Space Name</label><input type="text" id="space-name" placeholder="e.g., TechHub, Family Chat..." maxlength="30"><small>Give your space a memorable name</small></div><div class="form-group"><label>Your Name</label><input type="text" id="creator-name" placeholder="Enter your name..." maxlength="30"></div><button class="btn btn-primary" onclick="createSpace()">Create Space</button></div></div>';
      } else if (state.screen === 'join') {
        h = '<div class="form-screen"><div class="form-card"><div class="form-header"><button class="back-btn" onclick="goToScreen(\'welcome\')">‚Üê</button><h2>Join Space</h2></div><div class="form-group"><label>Passcode</label><input type="text" id="join-passcode" placeholder="ABC123" maxlength="6" style="text-transform:uppercase;letter-spacing:0.25rem;text-align:center;font-weight:600"></div><button class="btn btn-primary" onclick="joinSpace()">Continue</button></div></div>';
      } else if (state.screen === 'enter-name') {
        h = '<div class="form-screen"><div class="form-card"><div class="form-header"><button class="back-btn" onclick="goToScreen(\'join\')">‚Üê</button><h2>Join Space</h2></div><div class="space-created-info"><h3>Joining</h3><div class="space-name-display">' + escapeHtml(state.spaceName) + '</div><small>üîë ' + state.passcode + '</small></div><div class="form-group"><label>Your Name</label><input type="text" id="joiner-name" placeholder="Enter your name..." maxlength="30"></div><button class="btn btn-primary" onclick="completeJoin()">Join ‚Üí</button></div></div>';
      } else if (state.screen === 'chat') {
        h = '<div class="chat-container"><div class="header" id="chat-header"></div><div class="messages-area" id="messages-scroll"><div class="messages-container" id="messages-container"></div></div><div id="typing-area"></div><div class="input-area" id="input-area"></div><div id="modal-area"></div></div>';
      }
      document.getElementById('app').innerHTML = h;
      if (state.screen === 'chat') { renderHeader(); renderMessages(); renderTypingIndicator(); renderInputArea(); scrollToBottom(); }
      ['space-name', 'creator-name', 'join-passcode', 'joiner-name'].forEach(function(id) { var inp = document.getElementById(id); if (inp) inp.addEventListener('keypress', function(e) { if (e.key === 'Enter') { e.preventDefault(); if (id === 'space-name') document.getElementById('creator-name').focus(); else if (id === 'creator-name') createSpace(); else if (id === 'join-passcode') joinSpace(); else completeJoin(); } }); });
    }

    function init() {
      if (storage.get('darkMode') === 'true') { state.darkMode = true; document.body.classList.add('dark-mode'); }
      if ('Notification' in window) state.notificationPermission = Notification.permission;
      loadMySpaces();
      var sp = storage.get('current-space'), un = storage.get('current-username'), sn = storage.get('current-spacename');
      if (sp && un) { state.passcode = sp; state.username = un; state.spaceName = sn || 'Space ' + sp; state.screen = 'chat'; subscribeToSpace(); }
      render();
      document.addEventListener('visibilitychange', function() { if (!document.hidden && state.screen === 'chat') markMessagesAsRead(); });
    }

    init();
  </script>
</body>
</html>
