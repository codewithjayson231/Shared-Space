<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shared Space - Chat & File Sharing</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f5f5dc;
      min-height: 100vh;
    }

    /* Light Mode Colors */
    :root {
      --bg-primary: #f5f5dc;
      --bg-secondary: #ffffff;
      --bg-header: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
      --text-primary: #4a3728;
      --text-secondary: #6b5344;
      --text-muted: #8b7355;
      --border-color: #d4c4a8;
      --msg-own-bg: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
      --msg-other-bg: #ffffff;
      --input-bg: #ffffff;
      --button-bg: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
      --button-hover: linear-gradient(135deg, #723a10 0%, #8b4513 100%);
      --accent: #8b4513;
      --accent-light: #deb887;
    }

    /* Dark Mode Colors */
    body.dark-mode {
      --bg-primary: #2c2416;
      --bg-secondary: #3d3225;
      --bg-header: linear-gradient(135deg, #5c3317 0%, #6b4423 100%);
      --text-primary: #f5f5dc;
      --text-secondary: #d4c4a8;
      --text-muted: #a89070;
      --border-color: #4a3f30;
      --msg-own-bg: linear-gradient(135deg, #6b4423 0%, #7a5230 100%);
      --msg-other-bg: #3d3225;
      --input-bg: #3d3225;
      --button-bg: linear-gradient(135deg, #6b4423 0%, #7a5230 100%);
      --button-hover: linear-gradient(135deg, #5c3317 0%, #6b4423 100%);
      --accent: #deb887;
      --accent-light: #6b4423;
    }

    body.dark-mode {
      background-color: var(--bg-primary);
    }

    /* Loading Screen */
    .loading-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-header);
    }

    .loading-screen span {
      color: white;
      font-size: 1.25rem;
    }

    /* Join Screen */
    .join-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      background: var(--bg-header);
    }

    .join-card {
      background: var(--bg-secondary);
      border-radius: 1rem;
      padding: 2rem;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .join-card-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .join-card-header .icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .join-card-header h1 {
      color: var(--text-primary);
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
    }

    .join-card-header p {
      color: var(--text-muted);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .form-group input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      font-size: 1rem;
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-group input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
    }

    .form-group input::placeholder {
      color: var(--text-muted);
    }

    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .btn-primary {
      background: var(--button-bg);
      color: white;
      width: 100%;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--button-hover);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-small {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 0.375rem;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-small:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .join-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1.5rem;
    }

    .join-footer span {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .theme-toggle {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      padding: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1.25rem;
      line-height: 1;
    }

    /* Main Chat Layout */
    .chat-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
    }

    /* Header */
    .header {
      background: var(--bg-header);
      color: white;
      padding: 0.75rem 1rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header-content {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .header-left .icon {
      font-size: 1.5rem;
    }

    .header-left h1 {
      font-size: 1.125rem;
      font-weight: 700;
    }

    .header-left p {
      font-size: 0.75rem;
      opacity: 0.8;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Messages Area */
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .messages-container {
      max-width: 900px;
      margin: 0 auto;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-muted);
    }

    .empty-state .icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    /* Message Styles */
    .message-wrapper {
      margin-bottom: 0.75rem;
      display: flex;
    }

    .message-wrapper.own {
      justify-content: flex-end;
    }

    .message-wrapper.other {
      justify-content: flex-start;
    }

    .message-bubble {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .message-wrapper.own .message-bubble {
      background: var(--msg-own-bg);
      color: white;
      border-bottom-right-radius: 0.25rem;
    }

    .message-wrapper.other .message-bubble {
      background: var(--msg-other-bg);
      color: var(--text-primary);
      border-bottom-left-radius: 0.25rem;
    }

    .message-sender {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.25rem;
    }

    .message-text {
      word-wrap: break-word;
      line-height: 1.4;
    }

    .message-time {
      font-size: 0.675rem;
      margin-top: 0.25rem;
      opacity: 0.7;
    }

    .message-wrapper.own .message-time {
      color: rgba(255, 255, 255, 0.7);
    }

    .message-wrapper.other .message-time {
      color: var(--text-muted);
    }

    /* System Message */
    .system-message {
      text-align: center;
      margin-bottom: 0.75rem;
    }

    .system-message span {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: var(--bg-secondary);
      color: var(--text-muted);
      font-size: 0.75rem;
      border-radius: 1rem;
      border: 1px solid var(--border-color);
    }

    /* File Message */
    .file-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .file-icon {
      font-size: 1.5rem;
    }

    .file-details {
      flex: 1;
      min-width: 0;
    }

    .file-name {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-size {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .file-preview-img {
      max-height: 200px;
      border-radius: 0.5rem;
      margin: 0.5rem 0;
      cursor: pointer;
    }

    .file-preview-img:hover {
      opacity: 0.9;
    }

    .file-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .file-btn {
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      border-radius: 1rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .message-wrapper.own .file-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .message-wrapper.own .file-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .message-wrapper.other .file-btn {
      background: var(--accent-light);
      color: var(--text-primary);
    }

    .message-wrapper.other .file-btn:hover {
      background: var(--border-color);
    }

    /* Typing Indicator */
    .typing-indicator {
      padding: 0.5rem 1rem;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
    }

    .typing-content {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .typing-dots {
      display: flex;
      gap: 0.25rem;
    }

    .typing-dot {
      width: 0.5rem;
      height: 0.5rem;
      background: var(--text-muted);
      border-radius: 50%;
      animation: bounce 1s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .typing-dot:nth-child(3) { animation-delay: 0.3s; }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }

    /* Input Area */
    .input-area {
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      padding: 0.75rem 1rem;
    }

    .input-container {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .attach-btn {
      background: none;
      border: none;
      font-size: 1.25rem;
      padding: 0.5rem;
      cursor: pointer;
      border-radius: 50%;
      transition: background 0.2s;
      color: var(--text-muted);
    }

    .attach-btn:hover {
      background: var(--bg-primary);
      color: var(--accent);
    }

    .message-input {
      flex: 1;
      padding: 0.625rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 1.5rem;
      font-size: 1rem;
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s;
    }

    .message-input:focus {
      border-color: var(--accent);
    }

    .message-input::placeholder {
      color: var(--text-muted);
    }

    .send-btn {
      background: var(--button-bg);
      color: white;
      border: none;
      padding: 0.625rem 1.5rem;
      border-radius: 1.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .send-btn:hover:not(:disabled) {
      background: var(--button-hover);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Preview Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 1000;
    }

    .modal-actions {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    .modal-btn {
      background: white;
      color: #333;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
      cursor: pointer;
    }

    .modal-btn:hover {
      background: #f0f0f0;
    }

    .modal-content {
      max-width: 1000px;
      max-height: 85vh;
      overflow: auto;
      background: white;
      border-radius: 0.5rem;
    }

    .modal-content img {
      max-width: 100%;
      display: block;
    }

    .modal-content iframe {
      width: 900px;
      height: 80vh;
      border: none;
    }

    /* Hidden */
    .hidden {
      display: none !important;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .message-bubble {
        max-width: 90%;
      }

      .header-left h1 {
        font-size: 1rem;
      }

      .send-btn {
        padding: 0.625rem 1rem;
      }

      .modal-content iframe {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    var MAX_FILE_SIZE = 10 * 1024 * 1024;
    var STORAGE_PREFIX = 'shared_space_';

    // State
    var state = {
      username: '',
      isJoined: false,
      messages: [],
      newMessage: '',
      typingUsers: [],
      isLoading: true,
      uploadingFile: false,
      previewFile: null,
      darkMode: false
    };

    var lastTypingUpdate = 0;
    var pollInterval = null;

    // Storage helpers
    var storage = {
      get: function(key) {
        try {
          return localStorage.getItem(STORAGE_PREFIX + key);
        } catch (e) { return null; }
      },
      set: function(key, value) {
        try {
          localStorage.setItem(STORAGE_PREFIX + key, value);
        } catch (e) {}
      },
      delete: function(key) {
        try {
          localStorage.removeItem(STORAGE_PREFIX + key);
        } catch (e) {}
      }
    };

    // Utility functions
    function formatTime(timestamp) {
      return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    function getFileIcon(fileType, fileName) {
      if (fileType && fileType.indexOf('image/') === 0) return 'üñºÔ∏è';
      if (fileType === 'application/pdf' || (fileName && fileName.indexOf('.pdf') > -1)) return 'üìÑ';
      if ((fileType && fileType.indexOf('word') > -1) || (fileName && /\.(doc|docx)$/i.test(fileName))) return 'üìù';
      if ((fileType && fileType.indexOf('excel') > -1) || (fileName && /\.(xls|xlsx)$/i.test(fileName))) return 'üìä';
      if ((fileType && fileType.indexOf('powerpoint') > -1) || (fileName && /\.(ppt|pptx)$/i.test(fileName))) return 'üìΩÔ∏è';
      if (fileType && fileType.indexOf('video/') === 0) return 'üé¨';
      if (fileType && fileType.indexOf('audio/') === 0) return 'üéµ';
      if (fileName && /\.(zip|rar|7z)$/i.test(fileName)) return 'üì¶';
      return 'üìé';
    }

    function canPreview(fileType, fileName) {
      return (fileType && fileType.indexOf('image/') === 0) || 
             fileType === 'application/pdf' || 
             (fileName && fileName.indexOf('.pdf') > -1);
    }

    function handleDownload(fileData, fileName) {
      var link = document.createElement('a');
      link.href = fileData;
      link.download = fileName;
      link.click();
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Dark mode
    function toggleDarkMode() {
      state.darkMode = !state.darkMode;
      storage.set('darkMode', state.darkMode.toString());
      if (state.darkMode) {
        document.body.classList.add('dark-mode');
      } else {
        document.body.classList.remove('dark-mode');
      }
      render();
    }

    // Messages
    function loadMessages() {
      var data = storage.get('shared-messages');
      if (data) {
        try {
          state.messages = JSON.parse(data);
        } catch (e) {}
      }
    }

    function saveMessages() {
      storage.set('shared-messages', JSON.stringify(state.messages.slice(-100)));
    }

    function addMessage(msg) {
      loadMessages();
      state.messages.push(msg);
      saveMessages();
      render();
      scrollToBottom();
    }

    // Typing
    function loadTyping() {
      var data = storage.get('typing-users');
      if (data) {
        try {
          var parsed = JSON.parse(data);
          var now = Date.now();
          state.typingUsers = [];
          for (var user in parsed) {
            if (parsed.hasOwnProperty(user) && now - parsed[user] < 5000 && user !== state.username) {
              state.typingUsers.push(user);
            }
          }
        } catch (e) {}
      }
    }

    function updateTyping() {
      var now = Date.now();
      if (now - lastTypingUpdate < 2000) return;
      lastTypingUpdate = now;

      var typingData = {};
      var data = storage.get('typing-users');
      if (data) {
        try { typingData = JSON.parse(data); } catch (e) {}
      }
      typingData[state.username] = now;
      storage.set('typing-users', JSON.stringify(typingData));
    }

    function clearTyping() {
      var typingData = {};
      var data = storage.get('typing-users');
      if (data) {
        try { typingData = JSON.parse(data); } catch (e) {}
      }
      delete typingData[state.username];
      storage.set('typing-users', JSON.stringify(typingData));
    }

    // Actions
    function handleJoin() {
      var input = document.getElementById('username-input');
      var username = input.value.trim();
      if (!username) return;

      state.username = username;
      state.isJoined = true;
      storage.set('my-username', username);

      addMessage({
        id: Date.now(),
        type: 'system',
        text: username + ' joined the space',
        timestamp: Date.now()
      });

      startPolling();
      render();
    }

    function handleLeave() {
      storage.delete('my-username');
      state.isJoined = false;
      state.username = '';
      stopPolling();
      render();
    }

    function handleSendMessage() {
      if (!state.newMessage.trim()) return;

      addMessage({
        id: Date.now(),
        type: 'text',
        sender: state.username,
        text: state.newMessage.trim(),
        timestamp: Date.now()
      });

      state.newMessage = '';
      clearTyping();
      render();
    }

    function handleFileUpload(e) {
      var file = e.target.files ? e.target.files[0] : null;
      if (!file) return;

      if (file.size > MAX_FILE_SIZE) {
        alert('File too large! Maximum size is 10MB. Your file is ' + (file.size / 1024 / 1024).toFixed(2) + 'MB');
        return;
      }

      state.uploadingFile = true;
      render();

      var reader = new FileReader();
      reader.onload = function(event) {
        addMessage({
          id: Date.now(),
          type: 'file',
          sender: state.username,
          fileName: file.name,
          fileType: file.type,
          fileSize: file.size,
          fileData: event.target.result,
          timestamp: Date.now()
        });
        state.uploadingFile = false;
        render();
      };
      reader.onerror = function() {
        alert('Failed to read file');
        state.uploadingFile = false;
        render();
      };
      reader.readAsDataURL(file);
      e.target.value = '';
    }

    function openPreview(msgId) {
      for (var i = 0; i < state.messages.length; i++) {
        if (state.messages[i].id === msgId) {
          state.previewFile = state.messages[i];
          break;
        }
      }
      render();
    }

    function closePreview() {
      state.previewFile = null;
      render();
    }

    function scrollToBottom() {
      setTimeout(function() {
        var container = document.getElementById('messages-container');
        if (container) container.scrollTop = container.scrollHeight;
      }, 50);
    }

    // Polling
    function startPolling() {
      pollInterval = setInterval(function() {
        loadMessages();
        loadTyping();
        render();
      }, 2000);
    }

    function stopPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    }

    // Render functions
    function renderLoading() {
      return '<div class="loading-screen"><span>Loading...</span></div>';
    }

    function renderJoinScreen() {
      return '<div class="join-screen">' +
        '<div class="join-card">' +
          '<div class="join-card-header">' +
            '<div class="icon">‚òï</div>' +
            '<h1>Shared Space</h1>' +
            '<p>Chat & share files with anyone</p>' +
          '</div>' +
          '<div class="form-group">' +
            '<label>Choose your display name</label>' +
            '<input type="text" id="username-input" placeholder="Enter your name..." maxlength="30">' +
          '</div>' +
          '<button class="btn btn-primary" onclick="handleJoin()">Join Space</button>' +
          '<div class="join-footer">' +
            '<span>Max file size: 10MB</span>' +
            '<button class="theme-toggle" onclick="toggleDarkMode()">' + (state.darkMode ? '‚òÄÔ∏è' : 'üåô') + '</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    function renderMessage(msg) {
      if (msg.type === 'system') {
        return '<div class="system-message"><span>' + escapeHtml(msg.text) + '</span></div>';
      }

      var isOwn = msg.sender === state.username;
      var wrapperClass = isOwn ? 'own' : 'other';

      var content = '';
      if (msg.type === 'text') {
        content = '<div class="message-text">' + escapeHtml(msg.text) + '</div>';
      } else if (msg.type === 'file') {
        var isImage = msg.fileType && msg.fileType.indexOf('image/') === 0;
        content = '<div class="file-info">' +
            '<span class="file-icon">' + getFileIcon(msg.fileType, msg.fileName) + '</span>' +
            '<div class="file-details">' +
              '<div class="file-name">' + escapeHtml(msg.fileName) + '</div>' +
              '<div class="file-size">' + formatFileSize(msg.fileSize) + '</div>' +
            '</div>' +
          '</div>';
        
        if (isImage) {
          content += '<img src="' + msg.fileData + '" alt="' + escapeHtml(msg.fileName) + '" class="file-preview-img" onclick="openPreview(' + msg.id + ')">';
        }
        
        content += '<div class="file-actions">';
        if (canPreview(msg.fileType, msg.fileName)) {
          content += '<button class="file-btn" onclick="openPreview(' + msg.id + ')">üëÅÔ∏è Preview</button>';
        }
        content += '<button class="file-btn" onclick="handleDownload(\'' + msg.fileData + '\', \'' + escapeHtml(msg.fileName).replace(/'/g, "\\'") + '\')">‚¨áÔ∏è Download</button>';
        content += '</div>';
      }

      var senderHtml = isOwn ? '' : '<div class="message-sender">' + escapeHtml(msg.sender) + '</div>';

      return '<div class="message-wrapper ' + wrapperClass + '">' +
        '<div class="message-bubble">' +
          senderHtml +
          content +
          '<div class="message-time">' + formatTime(msg.timestamp) + '</div>' +
        '</div>' +
      '</div>';
    }

    function renderChat() {
      var messagesHtml = '';
      if (state.messages.length === 0) {
        messagesHtml = '<div class="empty-state"><div class="icon">üì≠</div><p>No messages yet. Start the conversation!</p></div>';
      } else {
        for (var i = 0; i < state.messages.length; i++) {
          messagesHtml += renderMessage(state.messages[i]);
        }
      }

      var typingHtml = '';
      if (state.typingUsers.length > 0) {
        var typingText = state.typingUsers.length === 1 
          ? state.typingUsers[0] + ' is typing...' 
          : state.typingUsers.join(', ') + ' are typing...';
        typingHtml = '<div class="typing-indicator">' +
          '<div class="typing-content">' +
            '<div class="typing-dots">' +
              '<span class="typing-dot"></span>' +
              '<span class="typing-dot"></span>' +
              '<span class="typing-dot"></span>' +
            '</div>' +
            '<span>' + typingText + '</span>' +
          '</div>' +
        '</div>';
      }

      return '<div class="chat-container">' +
        '<div class="header">' +
          '<div class="header-content">' +
            '<div class="header-left">' +
              '<span class="icon">‚òï</span>' +
              '<div>' +
                '<h1>Shared Space</h1>' +
                '<p>Logged in as ' + escapeHtml(state.username) + '</p>' +
              '</div>' +
            '</div>' +
            '<div class="header-right">' +
              '<button class="btn-small" onclick="toggleDarkMode()">' + (state.darkMode ? '‚òÄÔ∏è' : 'üåô') + '</button>' +
              '<button class="btn-small" onclick="handleLeave()">Leave</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="messages-area" id="messages-container">' +
          '<div class="messages-container">' +
            messagesHtml +
          '</div>' +
        '</div>' +
        typingHtml +
        '<div class="input-area">' +
          '<div class="input-container">' +
            '<input type="file" id="file-input" class="hidden" onchange="handleFileUpload(event)">' +
            '<button class="attach-btn" onclick="document.getElementById(\'file-input\').click()"' + (state.uploadingFile ? ' disabled' : '') + '>' +
              (state.uploadingFile ? '‚è≥' : 'üìé') +
            '</button>' +
            '<input type="text" class="message-input" id="message-input" placeholder="Type a message..." value="' + escapeHtml(state.newMessage) + '">' +
            '<button class="send-btn" onclick="handleSendMessage()"' + (!state.newMessage.trim() ? ' disabled' : '') + '>Send</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    function renderPreviewModal() {
      if (!state.previewFile) return '';

      var isImage = state.previewFile.fileType && state.previewFile.fileType.indexOf('image/') === 0;
      var contentHtml = isImage 
        ? '<img src="' + state.previewFile.fileData + '" alt="' + escapeHtml(state.previewFile.fileName) + '">'
        : '<iframe src="' + state.previewFile.fileData + '" title="' + escapeHtml(state.previewFile.fileName) + '"></iframe>';

      return '<div class="modal-overlay" onclick="if(event.target === this) closePreview()">' +
        '<div class="modal-actions">' +
          '<button class="modal-btn" onclick="handleDownload(\'' + state.previewFile.fileData + '\', \'' + escapeHtml(state.previewFile.fileName).replace(/'/g, "\\'") + '\')">‚¨áÔ∏è Download</button>' +
          '<button class="modal-btn" onclick="closePreview()">‚úï Close</button>' +
        '</div>' +
        '<div class="modal-content">' +
          contentHtml +
        '</div>' +
      '</div>';
    }

    function render() {
      var html = '';
      
      if (state.isLoading) {
        html = renderLoading();
      } else if (!state.isJoined) {
        html = renderJoinScreen();
      } else {
        html = renderChat() + renderPreviewModal();
      }

      document.getElementById('app').innerHTML = html;

      // Set up input event listeners
      var messageInput = document.getElementById('message-input');
      if (messageInput) {
        messageInput.addEventListener('input', function(e) {
          state.newMessage = e.target.value;
          if (e.target.value) updateTyping();
        });
        messageInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') handleSendMessage();
        });
        messageInput.addEventListener('blur', function() {
          clearTyping();
        });
      }

      var usernameInput = document.getElementById('username-input');
      if (usernameInput) {
        usernameInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') handleJoin();
        });
      }
    }

    // Initialize
    function init() {
      // Load dark mode
      if (storage.get('darkMode') === 'true') {
        state.darkMode = true;
        document.body.classList.add('dark-mode');
      }

      // Load username
      var savedUsername = storage.get('my-username');
      if (savedUsername) {
        state.username = savedUsername;
        state.isJoined = true;
        loadMessages();
        startPolling();
      }

      state.isLoading = false;
      render();
      scrollToBottom();
    }

    init();
  </script>
</body>
</html>
